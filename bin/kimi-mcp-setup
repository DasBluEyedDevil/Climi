#!/usr/bin/env bash
set -e

VERSION="1.0.0"
KIMI_MCP_CONFIG="${HOME}/.kimi/mcp.json"

show_help() {
    cat << 'EOF'
Kimi MCP Setup - Configure Kimi CLI to use Kimi MCP Bridge

Usage: kimi-mcp-setup [command]

Commands:
  install         Add Kimi MCP Bridge to Kimi CLI's MCP servers
  remove          Remove Kimi MCP Bridge from Kimi CLI's MCP servers
  status          Show configuration status
  --help, -h      Show this help message
  --version, -v   Show version information

Examples:
  # Register our MCP server with Kimi CLI
  kimi-mcp-setup install

  # Check if configured
  kimi-mcp-setup status

  # Remove configuration
  kimi-mcp-setup remove

For more information: https://github.com/dasblitz/climi
EOF
}

show_version() {
    echo "kimi-mcp-setup version $VERSION"
}

get_server_path() {
    # Try to find the server executable
    local script_dir="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
    local project_root="$(dirname "$script_dir")"
    
    if [[ -f "$project_root/mcp-bridge/bin/kimi-mcp-server" ]]; then
        echo "$project_root/mcp-bridge/bin/kimi-mcp-server"
    elif [[ -f "${HOME}/.config/opencode/get-shit-done/mcp-bridge/bin/kimi-mcp-server" ]]; then
        echo "${HOME}/.config/opencode/get-shit-done/mcp-bridge/bin/kimi-mcp-server"
    else
        echo ""
    fi
}

install_config() {
    local server_path="$(get_server_path)"
    
    if [[ -z "$server_path" ]]; then
        echo "Error: Could not find kimi-mcp-server" >&2
        echo "Please run install.sh first" >&2
        exit 1
    fi
    
    # Ensure config directory exists
    mkdir -p "$(dirname "$KIMI_MCP_CONFIG")"
    
    # Read existing config or create new
    local config="{}"
    if [[ -f "$KIMI_MCP_CONFIG" ]]; then
        config="$(cat "$KIMI_MCP_CONFIG")"
    fi
    
    # Add our server to mcpServers
    local new_config="$(echo "$config" | jq --arg path "$server_path" '
        .mcpServers = (.mcpServers // {}) |
        .mcpServers["kimi-bridge"] = {
            "command": $path,
            "args": [],
            "env": {}
        }
    ')"
    
    echo "$new_config" > "$KIMI_MCP_CONFIG"
    echo "✓ Added kimi-bridge to Kimi MCP configuration"
    echo "  Config file: $KIMI_MCP_CONFIG"
    echo ""
    echo "You can now use Kimi MCP Bridge through Kimi CLI:"
    echo "  kimi mcp list"
    echo "  kimi mcp test kimi-bridge"
}

remove_config() {
    if [[ ! -f "$KIMI_MCP_CONFIG" ]]; then
        echo "No Kimi MCP configuration found"
        exit 0
    fi
    
    local config="$(cat "$KIMI_MCP_CONFIG")"
    local new_config="$(echo "$config" | jq 'del(.mcpServers["kimi-bridge"])')"
    
    echo "$new_config" > "$KIMI_MCP_CONFIG"
    echo "✓ Removed kimi-bridge from Kimi MCP configuration"
}

show_status() {
    echo "Kimi MCP Bridge Setup Status"
    echo "============================"
    echo ""
    
    # Check server executable
    local server_path="$(get_server_path)"
    if [[ -n "$server_path" && -f "$server_path" ]]; then
        echo "✓ Server executable: $server_path"
    else
        echo "✗ Server executable not found"
        echo "  Run: ./install.sh"
    fi
    
    # Check Kimi CLI MCP config
    echo ""
    if [[ -f "$KIMI_MCP_CONFIG" ]]; then
        echo "✓ Kimi MCP config: $KIMI_MCP_CONFIG"
        
        if jq -e '.mcpServers["kimi-bridge"]' "$KIMI_MCP_CONFIG" >/dev/null 2>&1; then
            echo "✓ kimi-bridge is registered"
            echo ""
            echo "Test with:"
            echo "  kimi mcp test kimi-bridge"
        else
            echo "○ kimi-bridge is NOT registered"
            echo ""
            echo "Register with:"
            echo "  kimi-mcp-setup install"
        fi
    else
        echo "○ Kimi MCP config not found"
        echo ""
        echo "Initialize with:"
        echo "  kimi-mcp-setup install"
    fi
}

# Main
case "${1:-status}" in
    install)
        install_config
        ;;
    remove)
        remove_config
        ;;
    status)
        show_status
        ;;
    --help|-h)
        show_help
        ;;
    --version|-v)
        show_version
        ;;
    *)
        echo "Unknown command: $1" >&2
        echo "Run 'kimi-mcp-setup --help' for usage" >&2
        exit 1
        ;;
esac
