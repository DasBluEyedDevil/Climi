#!/usr/bin/env bash
set -e

# Determine installation directory
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(dirname "$SCRIPT_DIR")"

# Version
VERSION="1.0.0"

# Help message
show_help() {
    cat << 'EOF'
Kimi MCP Server - Expose Kimi as MCP tools

Usage: kimi-mcp [command]

Commands:
  start           Start the MCP server (reads JSON-RPC from stdin)
  --help, -h      Show this help message
  --version, -v   Show version information

Environment Variables:
  KIMI_MCP_MODEL       Default model (k2 or k2.5)
  KIMI_MCP_TIMEOUT     Default timeout in seconds

Configuration:
  ~/.config/kimi-mcp/config.json

Examples:
  # Start server
  kimi-mcp start

  # Test with a simple request
  echo '{"jsonrpc":"2.0","id":1,"method":"initialize"}' | kimi-mcp

For more information: https://github.com/dasblitz/climi
EOF
}

# Show version
show_version() {
    echo "kimi-mcp version $VERSION"
    echo "Protocol version: 2025-11-25"
}

# Start server
start_server() {
    local server_path="${PROJECT_ROOT}/mcp-bridge/bin/kimi-mcp-server"
    
    if [[ ! -f "$server_path" ]]; then
        echo "Error: MCP server not found at $server_path" >&2
        echo "Please run install.sh to install MCP bridge components" >&2
        exit 1
    fi
    
    exec "$server_path"
}

# Main
case "${1:-start}" in
    start)
        start_server
        ;;
    --help|-h)
        show_help
        ;;
    --version|-v)
        show_version
        ;;
    *)
        echo "Unknown command: $1" >&2
        echo "Run 'kimi-mcp --help' for usage" >&2
        exit 1
        ;;
esac
