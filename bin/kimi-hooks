#!/bin/bash
# kimi-hooks: CLI for managing Kimi git hooks

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"

# Source the installation library
source "$PROJECT_ROOT/hooks/lib/install.sh"

VERSION="1.0.0"

show_help() {
    cat << EOF
Kimi Git Hooks CLI v${VERSION}

Usage: kimi-hooks <command> [options]

Commands:
  install [--global|--local]   Install hooks (default: local)
  uninstall [--global|--local] Uninstall hooks (default: all)
  status                       Show installation status
  enable <hook>                Enable a hook type
  disable <hook>               Disable a hook type
  config                       Open configuration in editor
  --help                       Show this help message
  --version                    Show version

Hook Types:
  pre-commit      Run before each commit
  post-checkout   Run after branch checkout
  pre-push        Run before each push

Examples:
  kimi-hooks install --global        # Install hooks globally
  kimi-hooks enable pre-commit       # Enable pre-commit hook
  kimi-hooks disable pre-push        # Disable pre-push hook
  kimi-hooks config                  # Edit configuration

Environment Variables:
  KIMI_HOOKS_SKIP=1    Skip all hooks
  EDITOR               Editor for config command
EOF
}

cmd_install() {
    # Delegate to kimi-hooks-setup
    exec "$PROJECT_ROOT/bin/kimi-hooks-setup" install "$@"
}

cmd_uninstall() {
    # Delegate to kimi-hooks-setup
    exec "$PROJECT_ROOT/bin/kimi-hooks-setup" uninstall "$@"
}

cmd_status() {
    # Delegate to kimi-hooks-setup
    exec "$PROJECT_ROOT/bin/kimi-hooks-setup" status "$@"
}

cmd_enable() {
    local hook="${1:-}"
    if [[ -z "$hook" ]]; then
        echo "Error: Hook type required"
        echo "Usage: kimi-hooks enable <hook-type>"
        echo "Valid types: pre-commit, post-checkout, pre-push"
        exit 1
    fi
    
    # Create or update user config
    local config_dir="$HOME/.config/kimi"
    local config_file="$config_dir/hooks.json"
    
    mkdir -p "$config_dir"
    
    if [[ -f "$config_file" ]]; then
        # Update existing config
        jq --arg hook "$hook" '
            if .hooks[$hook] then
                .hooks[$hook].enabled = true
            else
                .hooks[$hook] = {"enabled": true}
            end
        ' "$config_file" > "$config_file.tmp" && mv "$config_file.tmp" "$config_file"
    else
        # Create new config
        cat > "$config_file" << EOF
{
  "version": "1.0",
  "hooks": {
    "$hook": {
      "enabled": true
    }
  }
}
EOF
    fi
    
    echo "Enabled $hook hook in $config_file"
}

cmd_disable() {
    local hook="${1:-}"
    if [[ -z "$hook" ]]; then
        echo "Error: Hook type required"
        echo "Usage: kimi-hooks disable <hook-type>"
        echo "Valid types: pre-commit, post-checkout, pre-push"
        exit 1
    fi
    
    # Create or update user config
    local config_dir="$HOME/.config/kimi"
    local config_file="$config_dir/hooks.json"
    
    mkdir -p "$config_dir"
    
    if [[ -f "$config_file" ]]; then
        # Update existing config
        jq --arg hook "$hook" '
            if .hooks[$hook] then
                .hooks[$hook].enabled = false
            else
                .hooks[$hook] = {"enabled": false}
            end
        ' "$config_file" > "$config_file.tmp" && mv "$config_file.tmp" "$config_file"
    else
        # Create new config
        cat > "$config_file" << EOF
{
  "version": "1.0",
  "hooks": {
    "$hook": {
      "enabled": false
    }
  }
}
EOF
    fi
    
    echo "Disabled $hook hook in $config_file"
}

cmd_config() {
    local config_dir="$HOME/.config/kimi"
    local config_file="$config_dir/hooks.json"
    
    if [[ ! -f "$config_file" ]]; then
        mkdir -p "$config_dir"
        cp "$PROJECT_ROOT/hooks/config/default.json" "$config_file"
        echo "Created default config at $config_file"
    fi
    
    ${EDITOR:-vi} "$config_file"
}

main() {
    case "${1:-}" in
        install)
            shift
            cmd_install "$@"
            ;;
        uninstall)
            shift
            cmd_uninstall "$@"
            ;;
        status)
            shift
            cmd_status "$@"
            ;;
        enable)
            shift
            cmd_enable "$@"
            ;;
        disable)
            shift
            cmd_disable "$@"
            ;;
        config)
            shift
            cmd_config "$@"
            ;;
        --help|-h)
            show_help
            ;;
        --version|-v)
            echo "kimi-hooks v${VERSION}"
            ;;
        *)
            echo "Unknown command: ${1:-}"
            show_help
            exit 1
            ;;
    esac
}

main "$@"
