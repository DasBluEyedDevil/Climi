# Milestone v2.0: Autonomous Delegation

**Status:** ✅ SHIPPED 2026-02-05
**Phases:** 8-12
**Total Plans:** 18

## Overview

Enable aggressive autonomous delegation by exposing Kimi as MCP tools and auto-invoking it for hands-on coding tasks, preserving Claude Code tokens for architecture and coordination.

## Phases

### Phase 8: MCP Bridge

**Goal**: Implement MCP server exposing Kimi as callable tools for external AI systems
**Depends on**: Configuration system foundation (Phase 7 from v1.0 baseline)
**Plans**: 5 plans

Plans:

- [x] 08-01: MCP Protocol Foundation (JSON-RPC, error codes)
- [x] 08-02: Configuration Management (config file, env vars)
- [x] 08-03: Tool Handlers (4 tools, file reading)
- [x] 08-04: Main Server Executable (message loop, lifecycle)
- [x] 08-05: CLI Integration (kimi-mcp command, install)

**Details:**

**Goal:** Implement MCP server exposing Kimi as callable tools for external AI systems

**Requirements:**
- MCP-01: MCP server implementation
- MCP-02 to MCP-05: Tool implementations (analyze, implement, refactor, verify)
- MCP-06: Transport modes (stdio - HTTP deferred)
- MCP-07: Configuration per tool
- MCP-08: Error handling
- CONF-09: CLI command to start MCP server

**Wave Structure:**
| Wave | Plans | Description |
|------|-------|-------------|
| 1 | 08-01 | Core protocol (independent) |
| 2 | 08-02 | Configuration (independent) |
| 3 | 08-03 | Tool handlers (needs 01, 02) |
| 4 | 08-04 | Server executable (needs 01-03) |
| 5 | 08-05 | CLI integration (needs 04) |

**Success Criteria:**
1. MCP server starts and responds to tool calls
2. Each tool (analyze, implement, refactor, verify) works correctly
3. stdio transport functions (HTTP deferred to future)
4. Configuration affects tool behavior as expected
5. Errors return meaningful MCP error codes

---

### Phase 9: Hooks System

**Goal**: Implement predefined git hooks that auto-delegate hands-on coding tasks to Kimi
**Depends on**: MCP Bridge (Phase 8) for tool invocation
**Plans**: 4 plans

Plans:

- [x] 09-01: Configuration System (config file, loading, defaults)
- [x] 09-02: Hook Scripts (pre-commit, post-checkout, pre-push)
- [x] 09-03: Installer (global/local install, CLI tools)
- [x] 09-04: Integration (install.sh, README, verification)

**Details:**

**Goal:** Implement predefined git hooks that auto-delegate hands-on coding tasks to Kimi

**Requirements:**
- HOOK-01: Git pre-commit hook
- HOOK-02: Git post-checkout hook
- HOOK-03: Git pre-push hook
- HOOK-04: File watcher hook (on-save) - *deferred per context*
- HOOK-05: Hook installer (global/local)
- HOOK-06: Hook configuration file
- HOOK-07: Selective hook enablement
- HOOK-08: Hook bypass mechanism
- HOOK-09: Dry-run mode

**Wave Structure:**
| Wave | Plans | Description |
|------|-------|-------------|
| 1 | 09-01 | Configuration system (independent) |
| 2 | 09-02 | Hook scripts (needs config) |
| 3 | 09-03 | Installer (needs hook scripts) |
| 4 | 09-04 | Integration (needs installer) |

**Success Criteria:**
1. Hooks install successfully (both global and per-project)
2. Pre-commit hook auto-fixes issues before commit
3. Post-checkout hook analyzes changed files
4. Pre-push hook runs tests and fixes failures
5. Configuration controls hook behavior correctly

---

### Phase 10: Enhanced SKILL.md

**Goal**: Implement smart triggers for autonomous delegation with intelligent model selection (K2 for routine, K2.5 for creative/UI)
**Depends on**: Hooks System (Phase 9) for trigger points
**Plans**: 4 plans

Plans:

- [x] 10-01: Configuration and Classification (model-rules.json, task-classifier.sh)
- [x] 10-02: Model Selection Engine (kimi-model-selector.sh with confidence scoring)
- [x] 10-03: Cost Estimation and Wrapper Integration (kimi-cost-estimator.sh, enhanced wrapper)
- [x] 10-04: Documentation Update (SKILL.md with v2.0 patterns)

**Details:**

**Goal:** Implement smart triggers for autonomous delegation with intelligent model selection (K2 for routine, K2.5 for creative/UI)

**Requirements:**
- SKILL-01: Model selection logic (K2 vs K2.5)
- SKILL-02: File extension → model mapping
- SKILL-03: Task type → model mapping
- SKILL-04: Code pattern detection triggers
- SKILL-05: Auto-delegation confidence threshold
- SKILL-06: Context preservation across delegations
- SKILL-07: Cost estimation before delegation
- SKILL-08: Override mechanism
- INT-02: Update SKILL.md with v2.0 patterns

**Wave Structure:**
| Wave | Plans | Description |
|------|-------|-------------|
| 1 | 10-01 | Configuration and classification (independent) |
| 2 | 10-02 | Model selection engine (needs 10-01) |
| 3 | 10-03 | Cost estimation and integration (needs 10-01, 10-02) |
| 4 | 10-04 | Documentation (needs all above) |

**Success Criteria:**
1. Routine tasks (refactoring, tests) use K2 automatically
2. Creative/UI tasks use K2.5 automatically
3. File extensions correctly map to appropriate models
4. Confidence threshold prevents low-confidence delegations
5. Cost estimates display before delegation

---

### Phase 11: Integration & Distribution

**Goal**: Update installer, documentation, and Claude Code integration for v2.0
**Depends on**: All previous phases complete
**Plans**: 4 plans

Plans:

- [x] 11-01: Update install.sh for v2.0 (MCP, hooks, model selection)
- [x] 11-02: Update CLAUDE.md with v2.0 commands and delegation patterns
- [x] 11-03: Create slash commands (/kimi-mcp, /kimi-hooks)
- [x] 11-04: Create documentation guides (MCP, hooks, model selection) and update README

**Details:**

**Goal:** Update installer, documentation, and Claude Code integration for v2.0

**Requirements:**
- INT-01: Update install.sh for v2.0
- INT-03: Update CLAUDE.md with new slash commands
- INT-04: Create `.claude/commands/kimi-mcp.md` slash command
- INT-05: Create `.claude/commands/kimi-hooks.md` slash command
- INT-06: MCP setup guide
- INT-07: Hooks configuration guide
- INT-08: Model selection best practices

**Wave Structure:**
| Wave | Plans | Description |
|------|-------|-------------|
| 1 | 11-01, 11-02 | Installer and CLAUDE.md updates (independent) |
| 2 | 11-03, 11-04 | Slash commands and documentation (needs 11-02 for command references) |

**Success Criteria:**
1. install.sh installs all v2.0 components
2. New slash commands work in Claude Code
3. Documentation covers MCP setup
4. Documentation covers hooks configuration
5. Model selection guide helps users understand K2 vs K2.5

---

### Phase 12: v2.0 Gap Closure

**Goal**: Close integration gap between Phase 10 (Model Selection) and Phase 8 (MCP Tools)
**Depends on**: Phases 8, 9, 10, 11 complete
**Plans**: 1 plan

Plans:

- [x] 12-01: Wire model selector into MCP tools (auto_model parameter, mcp_select_model helper, hooks update)

**Details:**

**Goal:** Close integration gap between Phase 10 (Model Selection) and Phase 8 (MCP Tools)

**Gap Addressed:** MCP Tools didn't use the model selection engine - they always used default model

**Resolution:**
- Added `auto_model` boolean parameter to all 4 MCP tool inputSchemas
- Modified all tool handlers to call `kimi-model-selector.sh` when `auto_model: true`
- Updated hooks to pass `auto_model: true` in JSON-RPC requests
- Added `mcp_select_model()` helper to `mcp-core.sh` with multi-path resolution

**Success Criteria:**
1. MCP tools support auto_model parameter
2. When auto_model=true, tools use intelligent model selection
3. Hooks pass auto_model: true in requests
4. Full end-to-end flow: Hook → MCP → Model Selector → Kimi CLI

---

## Milestone Summary

**Key Decisions:**

| Decision | Rationale | Outcome |
|----------|-----------|---------|
| Pure Bash MCP implementation | Minimize dependencies for CLI integration | ✓ Good |
| Configuration precedence: env > user config > defaults | Flexible deployment and local customization | ✓ Good |
| Project config > user config | Project-specific needs take priority | ✓ Good |
| K2 for backend files, K2.5 for UI files | Routine tasks need fast model, creative tasks need strong model | ✓ Good |
| 75% confidence threshold | Balances automation with accuracy | ✓ Good |
| auto_model defaults to false | Backward compatibility - existing calls unaffected | ✓ Good |
| v2.0 features are additive | No breaking changes for existing installations | ✓ Good |

**Issues Resolved:**
- MCP protocol complexity mitigated with stdio-first approach
- Git hook performance addressed with timeout and async options
- Model selection accuracy tuned with multi-factor confidence scoring
- Cross-phase integration fully wired via Phase 12 gap closure

**Issues Deferred:**
- HTTP/SSE transport for MCP (stdio sufficient for v2.0)
- File watcher hook (on-save) - deferred per context decision
- IDE integration hooks (VSCode, IntelliJ) - v3.0 candidate
- Streaming responses for long-running tasks - v3.0 candidate

**Technical Debt:**
- None. All v2.0 requirements fully implemented.

---

_For current project status, see .planning/PROJECT.md_
