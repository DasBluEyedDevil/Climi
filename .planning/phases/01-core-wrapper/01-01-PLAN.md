---
phase: 01-core-wrapper
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - skills/kimi.agent.wrapper.sh
autonomous: true

must_haves:
  truths:
    - "Wrapper script exists and is executable"
    - "Wrapper finds kimi CLI via KIMI_PATH or PATH lookup"
    - "Wrapper exits with code 10 and platform-specific install instructions if kimi CLI not found"
    - "Wrapper warns (stderr) if kimi CLI version is below 1.7.0 but continues execution"
    - "Wrapper resolves agent files from project .kimi/agents/ first, then global install location"
    - "Wrapper accepts -r, -m, -w flags and passes them through to kimi CLI"
    - "Wrapper reads prompt from positional argument or stdin pipe"
    - "Wrapper emits machine-parseable header to stderr before kimi output"
    - "All wrapper messages go to stderr; only kimi output goes to stdout"
  artifacts:
    - path: "skills/kimi.agent.wrapper.sh"
      provides: "Complete Kimi CLI wrapper with validation, arg parsing, role resolution, and invocation"
      min_lines: 250
  key_links:
    - from: "skills/kimi.agent.wrapper.sh"
      to: "kimi CLI"
      via: "KIMI_PATH env var or command -v fallback"
      pattern: "KIMI_PATH.*command -v kimi"
    - from: "skills/kimi.agent.wrapper.sh"
      to: ".kimi/agents/<role>.yaml"
      via: "resolve_agent function with two-tier lookup"
      pattern: "resolve_agent"
    - from: "skills/kimi.agent.wrapper.sh"
      to: "kimi --quiet"
      via: "array-based command construction"
      pattern: 'cmd=.*--quiet'
---

<objective>
Write the complete `kimi.agent.wrapper.sh` bash script (~300 lines) that wraps Kimi CLI with role-based agent file selection, flag pass-through, and startup validation.

Purpose: This is the foundational script that all subsequent phases build on. It must invoke Kimi CLI correctly, resolve agent files, validate the environment, and keep stdout clean for piping.

Output: A single executable bash script at `skills/kimi.agent.wrapper.sh` covering all 7 Phase 1 requirements (WRAP-01, WRAP-02, WRAP-03, WRAP-08, WRAP-10, WRAP-12, WRAP-13).
</objective>

<execution_context>
@C:\Users\dasbl\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\dasbl\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@C:\Users\dasbl\Multi-Agent-Workflow\.planning\PROJECT.md
@C:\Users\dasbl\Multi-Agent-Workflow\.planning\ROADMAP.md
@C:\Users\dasbl\Multi-Agent-Workflow\.planning\STATE.md
@C:\Users\dasbl\Multi-Agent-Workflow\.planning\phases\01-core-wrapper\01-CONTEXT.md
@C:\Users\dasbl\Multi-Agent-Workflow\.planning\phases\01-core-wrapper\01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Write the complete kimi.agent.wrapper.sh script</name>
  <files>skills/kimi.agent.wrapper.sh</files>
  <action>
Create `skills/kimi.agent.wrapper.sh` -- a ~300-line bash script following the structure from 01-RESEARCH.md. Use the full 300-line budget; build thoroughly, not a skeleton.

**Script structure (follow this order):**

**Section 1: Header and strict mode (~lines 1-10)**
- Shebang: `#!/usr/bin/env bash`
- `set -euo pipefail`
- Script version constant (e.g., `WRAPPER_VERSION="1.0.0"`)
- `SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"`

**Section 2: Constants and defaults (~lines 11-30)**
- Exit codes as readonly: EXIT_SUCCESS=0, EXIT_CLI_NOT_FOUND=10, EXIT_BAD_ARGS=11, EXIT_ROLE_NOT_FOUND=12, EXIT_NO_PROMPT=13
- Default model: `DEFAULT_MODEL="kimi-for-coding"` (inherits user's kimi config mapping)
- Minimum version: `MIN_VERSION="1.7.0"`
- Initialize variables: ROLE="", MODEL="$DEFAULT_MODEL", WORK_DIR="", PROMPT="", AGENT_FILE=""
- Initialize passthrough array: `PASSTHROUGH_ARGS=()`

**Section 3: Utility functions (~lines 31-100)**

`die()` -- print error to stderr, exit with given code:
```
die() { echo "Error: $1" >&2; exit "${2:-1}"; }
```

`warn()` -- print warning to stderr:
```
warn() { echo "Warning: $1" >&2; }
```

`detect_os()` -- return "macos", "linux", "windows", or "unknown" using `uname -s`:
- Darwin* -> macos
- Linux* -> linux
- MINGW*|MSYS*|CYGWIN* -> windows

`show_install_instructions()` -- platform-specific install guidance to stderr:
- macos: `brew install kimi-cli` and `uv tool install kimi-cli` as alternative
- linux: `uv tool install kimi-cli` and `pip install kimi-cli` as alternative
- windows: `uv tool install kimi-cli` and `pip install kimi-cli` with KIMI_PATH tip
- All platforms: note "Requires Python >= 3.12 (3.13 recommended)"

`find_kimi()` -- resolve kimi binary path:
- Check `KIMI_PATH` env var first (addresses Windows PATH loss)
- Fall back to `command -v kimi 2>/dev/null || true`
- If found, echo the path. If not found, call `show_install_instructions` and `die` with EXIT_CLI_NOT_FOUND

`version_gte()` -- compare two semver strings, return 0 if $1 >= $2:
- Use `sort -V` approach: `printf '%s\n%s' "$v1" "$v2" | sort -V | tail -1` and check if result equals $v1
- This works on GNU coreutils (Linux), macOS, and Git Bash for Windows

`check_version()` -- validate kimi CLI version:
- Run `"$KIMI_BIN" --version 2>/dev/null` and extract version with `grep -oE '[0-9]+\.[0-9]+\.[0-9]+'| head -1`
- If extraction fails: `warn "Could not determine kimi CLI version"` and return (continue anyway)
- If version < MIN_VERSION: `warn "kimi CLI $version is below minimum $MIN_VERSION -- some features may not work"`
- Version mismatch is a WARNING, not a hard block (locked decision from CONTEXT.md)

`resolve_agent()` -- two-tier agent file resolution:
- Takes role name as $1
- Check project-local first: `.kimi/agents/${role}.yaml` (relative to working directory)
- Check global second: `${SCRIPT_DIR}/../.kimi/agents/${role}.yaml`
- If found: echo the path, return 0
- If not found: return 1

`list_available_roles()` -- enumerate available roles from both directories:
- Scan project `.kimi/agents/*.yaml` and global `${SCRIPT_DIR}/../.kimi/agents/*.yaml`
- Extract basenames without .yaml extension
- Deduplicate with `sort -u`
- Output comma-separated list

`die_role_not_found()` -- error with available roles list:
- Print "Error: role '<role>' not found." to stderr
- Call list_available_roles and show if non-empty
- Otherwise show "No agent files found in .kimi/agents/ or <global path>"
- Exit with EXIT_ROLE_NOT_FOUND

**Section 4: Argument parser (~lines 101-160)**

Manual while-case loop over `$@`:
- `-r|--role`: set ROLE="$2", shift 2
- `-m|--model`: set MODEL="$2", shift 2
- `-w|--work-dir`: set WORK_DIR="$2", shift 2
- `-h|--help`: call a `usage()` function that shows brief help (flags: -r ROLE, -m MODEL, -w PATH, -h; note that full help comes in Phase 4), then exit 0
- `-*`: unknown flags pass through to Kimi CLI -- append to PASSTHROUGH_ARGS array. If next arg exists and doesn't start with `-`, include it as the flag's value too.
- `*`: treat as PROMPT (first positional arg becomes the prompt)

After the loop, check for piped stdin: `if [[ -z "$PROMPT" && ! -t 0 ]]; then PROMPT=$(cat); fi`

If PROMPT is still empty after both checks: `die "No prompt provided. Usage: kimi.agent.wrapper.sh [-r role] [-m model] \"prompt\"" "$EXIT_NO_PROMPT"`

**Section 5: Validation (~lines 161-200)**

1. Find kimi binary: `KIMI_BIN=$(find_kimi)` -- this will die with install instructions if not found
2. Check version: `check_version`
3. If ROLE is set: resolve agent file via `resolve_agent "$ROLE"` -- if returns 1, call `die_role_not_found "$ROLE"`. Store resolved path in AGENT_FILE.

**Section 6: Command construction and invocation (~lines 201-270)**

Build command as array (NEVER use eval or string concatenation):
```bash
cmd=("$KIMI_BIN" "--quiet")
```

Add agent file if resolved:
```bash
[[ -n "$AGENT_FILE" ]] && cmd+=("--agent-file" "$AGENT_FILE")
```

Add model:
```bash
cmd+=("--model" "$MODEL")
```

Add working directory if specified:
```bash
[[ -n "$WORK_DIR" ]] && cmd+=("--work-dir" "$WORK_DIR")
```

Add passthrough args:
```bash
[[ ${#PASSTHROUGH_ARGS[@]} -gt 0 ]] && cmd+=("${PASSTHROUGH_ARGS[@]}")
```

Add prompt:
```bash
cmd+=("--prompt" "$PROMPT")
```

Emit machine-parseable header to stderr (for Phase 5 Claude Code integration):
```bash
echo "[kimi:${ROLE:-none}:${MODEL}]" >&2
```

Execute and propagate exit code:
```bash
kimi_exit=0
"${cmd[@]}" || kimi_exit=$?
exit "$kimi_exit"
```

**Section 7: usage() function (can be placed near top or before arg parsing)**

Minimal help output for Phase 1 (full --help in Phase 4):
```
Usage: kimi.agent.wrapper.sh [OPTIONS] PROMPT
  -r, --role ROLE      Agent role (maps to .kimi/agents/ROLE.yaml)
  -m, --model MODEL    Kimi model (default: kimi-for-coding)
  -w, --work-dir PATH  Working directory for Kimi
  -h, --help           Show this help
Prompt can also be piped via stdin.
```

**Critical implementation rules:**
- NO ANSI colors anywhere (locked decision: plain text only)
- ALL wrapper output to stderr; only kimi stdout passes through to stdout
- Always double-quote variables, especially $KIMI_BIN and $KIMI_PATH (Windows paths with spaces)
- Use arrays for command construction, never eval or string concatenation
- The `usage()` function should exit 0 after printing
- Handle the case where PASSTHROUGH_ARGS is empty carefully with bash arrays (use `${#PASSTHROUGH_ARGS[@]} -gt 0` guard)
  </action>
  <verify>
Run these checks:
1. `bash -n skills/kimi.agent.wrapper.sh` -- syntax check passes (exit 0)
2. `wc -l skills/kimi.agent.wrapper.sh` -- between 250-320 lines
3. `head -1 skills/kimi.agent.wrapper.sh` -- starts with `#!/usr/bin/env bash`
4. `grep -c 'set -euo pipefail' skills/kimi.agent.wrapper.sh` -- returns 1
5. `grep -c 'EXIT_CLI_NOT_FOUND=10' skills/kimi.agent.wrapper.sh` -- returns 1
6. `grep -c 'resolve_agent' skills/kimi.agent.wrapper.sh` -- returns at least 2 (definition + usage)
7. `grep -c 'command -v kimi' skills/kimi.agent.wrapper.sh` -- returns at least 1
8. `grep -c '\-\-quiet' skills/kimi.agent.wrapper.sh` -- returns at least 1
9. `grep -c 'KIMI_PATH' skills/kimi.agent.wrapper.sh` -- returns at least 1
10. `grep -c '\[kimi:' skills/kimi.agent.wrapper.sh` -- returns at least 1 (header format)
11. `grep -c 'sort -V' skills/kimi.agent.wrapper.sh` -- returns at least 1 (version comparison)
12. `grep -c '>&2' skills/kimi.agent.wrapper.sh` -- returns at least 5 (multiple stderr outputs)
  </verify>
  <done>
A complete, syntactically valid ~300-line bash script at `skills/kimi.agent.wrapper.sh` that:
- Detects kimi CLI via KIMI_PATH or PATH with platform-specific install instructions on failure
- Checks kimi version and warns if below 1.7.0
- Parses -r, -m, -w flags and passes unknowns through to kimi
- Resolves agent files from project-local then global directories
- Accepts prompt from positional arg or stdin pipe
- Builds kimi command as array, emits header to stderr, executes, propagates exit code
- Uses no ANSI colors, no eval, no which, no getopts
  </done>
</task>

<task type="auto">
  <name>Task 2: Validate wrapper against all 5 success criteria</name>
  <files>skills/kimi.agent.wrapper.sh</files>
  <action>
Run validation tests against the wrapper script to confirm it meets Phase 1 success criteria. These are non-destructive checks that verify script behavior WITHOUT requiring kimi CLI to be installed.

**Test 1: Help output works (SC5 partial -- flag handling)**
```bash
bash skills/kimi.agent.wrapper.sh -h
```
Should print usage info and exit 0.

**Test 2: Missing prompt detection (error handling)**
```bash
bash skills/kimi.agent.wrapper.sh -r reviewer 2>&1; echo "exit: $?"
```
Should print "Error: No prompt provided" to stderr and exit 13.

**Test 3: Piped stdin works (prompt input)**
```bash
echo "test prompt" | bash skills/kimi.agent.wrapper.sh -r reviewer 2>&1; echo "exit: $?"
```
If kimi is not installed, should fail with exit 10 and install instructions (which proves KIMI_PATH/PATH detection works -- SC3).
If kimi IS installed, it will attempt to run (which is fine).

**Test 4: Role not found shows available roles (SC2 partial)**
Create a temp agent file and test resolution:
```bash
mkdir -p /tmp/test-kimi-agents/.kimi/agents
echo "version: 1" > /tmp/test-kimi-agents/.kimi/agents/testrole.yaml
cd /tmp/test-kimi-agents
bash <path-to>/skills/kimi.agent.wrapper.sh -r nonexistent "test" 2>&1; echo "exit: $?"
```
Should show "Error: role 'nonexistent' not found" with "Available roles: testrole" and exit 12.
Clean up temp directory after.

**Test 5: Verify all exit codes are defined**
```bash
grep -E 'EXIT_[A-Z_]+=1[0-3]' skills/kimi.agent.wrapper.sh
```
Should show EXIT_CLI_NOT_FOUND=10, EXIT_BAD_ARGS=11, EXIT_ROLE_NOT_FOUND=12, EXIT_NO_PROMPT=13.

**Test 6: Verify stderr/stdout separation**
Check that all echo/printf in utility functions use `>&2`:
```bash
grep -n 'echo.*"Error:' skills/kimi.agent.wrapper.sh | grep -v '>&2'
grep -n 'echo.*"Warning:' skills/kimi.agent.wrapper.sh | grep -v '>&2'
```
Both should return empty (all error/warning output goes to stderr).

**Test 7: Verify machine-parseable header format**
```bash
grep -n '\[kimi:' skills/kimi.agent.wrapper.sh
```
Should show the header emission line using format `[kimi:<role>:<model>]` sent to stderr.

If any test fails, fix the issue in the script and re-run the failing test.
  </action>
  <verify>
All 7 tests pass:
1. `-h` prints usage and exits 0
2. Missing prompt exits 13 with error message
3. Piped stdin is detected (exit 10 if no kimi, or proceeds if kimi present)
4. Role not found shows available roles and exits 12
5. All 4 wrapper exit codes are defined
6. No error/warning output leaks to stdout
7. Machine-parseable header format is present
  </verify>
  <done>
The wrapper script passes all structural and behavioral validation tests. It correctly handles:
- Help flag (-h exits 0 with usage)
- Missing prompt (exits 13)
- Piped stdin detection
- Role not found (exits 12 with available roles)
- Defined exit codes (10, 11, 12, 13)
- stderr/stdout separation (all wrapper messages to stderr)
- Machine-parseable header format ([kimi:role:model])
  </done>
</task>

</tasks>

<verification>
Phase 1 success criteria verification (from ROADMAP.md):

1. **SC1: User can run `kimi.agent.wrapper.sh -r reviewer "review this code"` and receive Kimi output**
   - Verify: Script parses -r and positional prompt correctly, builds correct kimi command array
   - Note: Full end-to-end requires kimi CLI installed; structural verification confirms command construction

2. **SC2: Wrapper resolves agent files from project `.kimi/agents/` first, falling back to global**
   - Verify: `resolve_agent()` function checks project-local then `SCRIPT_DIR/../.kimi/agents/`
   - Verify: `grep -A5 'resolve_agent()' skills/kimi.agent.wrapper.sh` shows two-tier lookup

3. **SC3: Wrapper exits with clear error and install instructions if kimi CLI not found**
   - Verify: Running without kimi on PATH and without KIMI_PATH produces install instructions and exit 10
   - Verify: `grep -A10 'show_install_instructions' skills/kimi.agent.wrapper.sh` shows platform-specific messages

4. **SC4: Wrapper warns if Kimi CLI version is below minimum**
   - Verify: `check_version()` function extracts version and uses `version_gte()` comparison
   - Verify: Warning message goes to stderr, execution continues (not a blocker)

5. **SC5: User can pass -m and -w flags through to Kimi CLI**
   - Verify: Argument parser handles `-m|--model` and `-w|--work-dir`
   - Verify: Command construction adds `--model` and `--work-dir` to kimi args array
</verification>

<success_criteria>
- `skills/kimi.agent.wrapper.sh` exists, is executable, passes `bash -n` syntax check
- Script is 250-320 lines (using full 300-line budget)
- All 7 Phase 1 requirements (WRAP-01, WRAP-02, WRAP-03, WRAP-08, WRAP-10, WRAP-12, WRAP-13) are implemented
- All 5 success criteria from ROADMAP.md are satisfied
- All validation tests from Task 2 pass
</success_criteria>

<output>
After completion, create `.planning/phases/01-core-wrapper/01-01-SUMMARY.md`
</output>
