---
phase: 09-hooks-system
plan: 04
type: execute
wave: 4
depends_on: [09-03]
files_modified:
  - install.sh
  - hooks/README.md
autonomous: false

must_haves:
  truths:
    - "install.sh installs hooks components alongside other project components"
    - "Default hooks configuration is created during installation"
    - "README documents hook usage, configuration, and troubleshooting"
    - "Users can understand how to enable/disable hooks"
    - "Users know how to bypass hooks when needed"
  artifacts:
    - path: "install.sh"
      provides: "Updated installer with hooks support"
      contains: "install_hooks function"
    - path: "hooks/README.md"
      provides: "Hook documentation"
      contains: '["installation", "configuration", "hook types", "bypass", "troubleshooting"]'
  key_links:
    - from: "install.sh"
      to: "hooks/"
      via: "install_hooks function"
      pattern: 'install_hooks|hooks/.*'
---

<objective>
Integrate hooks system into the main installer and create comprehensive documentation.

Purpose: Ensure hooks are installed as part of the standard installation process and users have clear documentation.
Output: Updated install.sh and hooks/README.md with complete setup instructions.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@install.sh
@mcp-bridge/README.md

From install.sh pattern:
- Component-specific install functions (install_core, install_agents, etc.)
- Each function installs files and creates necessary directories
- Final summary shows what was installed

From mcp-bridge/README.md pattern:
- Quick start section
- Configuration section
- Usage examples
- Troubleshooting
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update install.sh for hooks system</name>
  <files>install.sh</files>
  <action>
Update install.sh to include hooks system installation:

1. Add to install_hooks() function (after install_mcp_bridge):
   - Create hooks directories (hooks/config, hooks/lib, hooks/hooks)
   - Copy hooks config files
   - Copy hooks library files
   - Copy hook scripts
   - Make scripts executable
   - Create ~/.config/kimi/ directory
   - Copy default config if doesn't exist

2. Update main() function:
   - Add install_hooks to the installation sequence
   - Add hooks to the summary output

3. Update show_summary():
   - Add hooks section showing:
     * CLI tools: kimi-hooks, kimi-hooks-setup
     * Config location: ~/.config/kimi/hooks.json
     * Quick start: kimi-hooks install --local

The install_hooks function should follow the same pattern as install_mcp_bridge:
- Check if HOOKS_DIR exists
- Create necessary directories
- Copy files
- Set permissions
- Show status

Add this function after install_mcp_bridge():

install_hooks() {
    log_info "Installing hooks system..."
    
    local hooks_dir="${SCRIPT_DIR}/hooks"
    
    if [[ ! -d "$hooks_dir" ]]; then
        log_warn "Hooks directory not found: $hooks_dir"
        log_warn "Skipping hooks installation"
        return 0
    fi
    
    # Create hooks directories
    mkdir -p "$INSTALL_DIR/hooks/config"
    mkdir -p "$INSTALL_DIR/hooks/lib"
    mkdir -p "$INSTALL_DIR/hooks/hooks"
    
    # Copy config files
    cp "$hooks_dir/config/default.json" "$INSTALL_DIR/hooks/config/"
    
    # Copy library files
    cp "$hooks_dir/lib/hooks-config.sh" "$INSTALL_DIR/hooks/lib/"
    cp "$hooks_dir/lib/hooks-common.sh" "$INSTALL_DIR/hooks/lib/"
    cp "$hooks_dir/lib/install.sh" "$INSTALL_DIR/hooks/lib/"
    
    # Copy hook scripts
    cp "$hooks_dir/hooks/pre-commit" "$INSTALL_DIR/hooks/hooks/"
    cp "$hooks_dir/hooks/post-checkout" "$INSTALL_DIR/hooks/hooks/"
    cp "$hooks_dir/hooks/pre-push" "$INSTALL_DIR/hooks/hooks/"
    
    # Make scripts executable
    chmod +x "$INSTALL_DIR/hooks/hooks/pre-commit"
    chmod +x "$INSTALL_DIR/hooks/hooks/post-checkout"
    chmod +x "$INSTALL_DIR/hooks/hooks/pre-push"
    
    # Create user config directory
    mkdir -p "$HOME/.config/kimi"
    
    # Copy default user config if doesn't exist
    if [[ ! -f "$HOME/.config/kimi/hooks.json" ]]; then
        cp "$hooks_dir/config/default.json" "$HOME/.config/kimi/hooks.json"
        log_info "Created default hooks config: ~/.config/kimi/hooks.json"
    fi
    
    log_success "Hooks system installed"
    log_info "  Config: ~/.config/kimi/hooks.json"
    log_info "  Run: kimi-hooks install --local (or --global)"
}

Then add install_hooks to the main installation sequence.
  </action>
  <verify>bash -n install.sh && echo "Syntax OK"</verify>
  <done>install.sh updated with install_hooks function and integrated into installation flow</done>
</task>

<task type="auto">
  <name>Task 2: Create hooks README documentation</name>
  <files>hooks/README.md</files>
  <action>
Create hooks/README.md with comprehensive documentation:

# Kimi Git Hooks

Auto-delegate coding tasks to Kimi via git hooks.

## Overview

Kimi Git Hooks automatically invoke Kimi analysis at key points in your git workflow:

- **pre-commit**: Analyze staged files and suggest fixes before committing
- **post-checkout**: Summarize changes when switching branches
- **pre-push**: Run tests and analyze failures before pushing

## Quick Start

```bash
# Install hooks in current repository
kimi-hooks install --local

# Or install globally (all repositories)
kimi-hooks install --global

# Check status
kimi-hooks status
```

## Installation

### Local (Per-Project)

Installs hooks in the current repository only:

```bash
kimi-hooks install --local
```

This creates symlinks in `.git/hooks/` pointing to the Kimi hook scripts.

### Global (All Repositories)

Installs hooks for all repositories (requires Git 2.9+):

```bash
kimi-hooks install --global
# Then enable global hooks:
git config --global core.hooksPath '~/.config/git/hooks'
```

### Via install.sh

Hooks are automatically installed when you run the main installer:

```bash
./install.sh
```

## Configuration

Configuration uses JSON files with the following precedence:

1. Environment variables (highest)
2. Project config (`.kimi/hooks.json`)
3. User config (`~/.config/kimi/hooks.json`)
4. Default config (lowest)

### Default Configuration

```json
{
  "version": "1.0",
  "enabled_hooks": ["pre-commit", "post-checkout", "pre-push"],
  "timeout_seconds": 60,
  "auto_fix": false,
  "dry_run": false,
  "file_patterns": ["*.py", "*.js", "*.ts", "*.sh"],
  "hooks": {
    "pre-commit": {
      "enabled": true,
      "auto_fix": false,
      "max_files": 50
    },
    "post-checkout": {
      "enabled": true,
      "max_files": 20
    },
    "pre-push": {
      "enabled": true,
      "run_tests": false,
      "test_command": ""
    }
  }
}
```

### Configuration Options

| Option | Description | Default |
|--------|-------------|---------|
| `enabled_hooks` | List of hook types to enable | `["pre-commit", "post-checkout", "pre-push"]` |
| `timeout_seconds` | Timeout for Kimi analysis | 60 |
| `auto_fix` | Automatically apply fixes | false |
| `dry_run` | Preview without making changes | false |
| `file_patterns` | File patterns to analyze | Language-specific |

### Hook-Specific Settings

Each hook type has its own configuration section:

- **pre-commit**: `auto_fix`, `max_files`, `check_types`
- **post-checkout**: `max_files`, `show_summary`
- **pre-push**: `run_tests`, `test_command`, `auto_fix_failures`

### Enable/Disable Hooks

```bash
# Enable a hook
kimi-hooks enable pre-commit

# Disable a hook
kimi-hooks disable pre-push

# Edit configuration directly
kimi-hooks config
```

## Hook Types

### pre-commit

Runs before each commit. Analyzes staged files for issues.

**Behavior:**
1. Gets list of staged files
2. Filters by file patterns
3. Runs Kimi analysis
4. Shows findings to user
5. If auto_fix enabled: applies fixes and re-stages

**Bypass:**
```bash
git commit --no-verify  # Skip pre-commit hook
# or
KIMI_HOOKS_SKIP=1 git commit
```

### post-checkout

Runs after branch checkout. Summarizes changes between branches.

**Behavior:**
1. Gets files changed between old and new branch
2. Filters by file patterns
3. Runs Kimi analysis for context
4. Shows summary to user

**Note:** Only runs on branch switches, not file checkouts.

### pre-push

Runs before each push. Can run tests and analyze failures.

**Behavior:**
1. Checks if test running is enabled
2. Runs configured test command
3. If tests fail and auto_fix enabled: analyzes and suggests fixes
4. Shows analysis to user

**Configuration:**
```json
{
  "hooks": {
    "pre-push": {
      "run_tests": true,
      "test_command": "npm test",
      "auto_fix_failures": false
    }
  }
}
```

## Bypassing Hooks

### Temporary Bypass

```bash
# Skip all hooks for this command
KIMI_HOOKS_SKIP=1 git commit -m "message"

# Skip pre-commit only
git commit --no-verify

# Skip pre-push only
git push --no-verify
```

### Permanent Disable

```bash
# Disable a specific hook
kimi-hooks disable pre-commit

# Or edit config
kimi-hooks config
```

## Dry Run Mode

Preview what Kimi would do without making changes:

```bash
# Enable dry-run in config
kimi-hooks config
# Set "dry_run": true

# Or via environment
KIMI_HOOKS_DRY_RUN=1 git commit
```

## Environment Variables

| Variable | Description |
|----------|-------------|
| `KIMI_HOOKS_SKIP` | Set to `1` to skip all hooks |
| `KIMI_HOOKS_DRY_RUN` | Set to `1` for dry-run mode |
| `KIMI_HOOKS_DEBUG` | Set to `1` for debug output |
| `KIMI_HOOKS_TIMEOUT` | Override timeout (seconds) |

## Troubleshooting

### Hooks not running

1. Check installation: `kimi-hooks status`
2. Verify hooks are enabled in config
3. Check that files match file_patterns
4. Try with debug: `KIMI_HOOKS_DEBUG=1 git commit`

### "command not found: kimi-hooks"

Ensure the bin directory is in your PATH:
```bash
export PATH="$HOME/.local/bin:$PATH"
```

### Global hooks not working

Verify Git version and core.hooksPath:
```bash
git --version  # Need 2.9+
git config --global core.hooksPath
```

### Slow hooks

- Reduce `timeout_seconds` in config
- Reduce `max_files` for specific hooks
- Disable hooks you don't need

### Conflicts with existing hooks

Local installation backs up existing hooks:
```bash
.git/hooks/pre-commit.backup.20240205120000
```

Restore if needed:
```bash
mv .git/hooks/pre-commit.backup.* .git/hooks/pre-commit
```

## Uninstallation

```bash
# Remove local hooks
kimi-hooks uninstall --local

# Remove global hooks
kimi-hooks uninstall --global

# Remove all hooks
kimi-hooks uninstall
```

## Requirements

- Git 2.9+ (for global hooks)
- Bash 4.0+
- jq 1.6+ (JSON parsing)
- Kimi CLI (for MCP tool invocation)

## See Also

- [MCP Bridge](../mcp-bridge/README.md) - Underlying MCP server
- [Main README](../README.md) - Project overview
  </action>
  <verify>[[ -f hooks/README.md ]] && head -30 hooks/README.md | grep -q "Kimi Git Hooks"</verify>
  <done>README.md exists with comprehensive documentation covering installation, configuration, and usage</done>
</task>

<task type="checkpoint:human-verify">
  <name>Task 3: Verify installation and documentation</name>
  <what-built>
Complete hooks system with:
- Configuration system (default.json, hooks-config.sh)
- Three hook scripts (pre-commit, post-checkout, pre-push)
- Installation tools (kimi-hooks, kimi-hooks-setup)
- Updated install.sh with hooks installation
- Comprehensive README.md
  </what-built>
  <how-to-verify>
1. Check that all files exist:
   ```bash
   ls hooks/config/default.json
   ls hooks/lib/*.sh
   ls hooks/hooks/pre-commit hooks/hooks/post-checkout hooks/hooks/pre-push
   ls bin/kimi-hooks bin/kimi-hooks-setup
   ls hooks/README.md
   ```

2. Verify install.sh has hooks support:
   ```bash
   grep -A 5 "install_hooks()" install.sh | head -10
   ```

3. Test CLI help:
   ```bash
   ./bin/kimi-hooks --help
   ./bin/kimi-hooks-setup --help
   ```

4. Review README for completeness:
   - Quick start section present
   - All hook types documented
   - Configuration options listed
   - Troubleshooting section included
  </how-to-verify>
  <resume-signal>Type "approved" to continue or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
1. install.sh contains install_hooks function
2. All hooks files are in place
3. CLI tools show help correctly
4. README covers all major topics
</verification>

<success_criteria>
- install.sh installs hooks components
- Default config copied to ~/.config/kimi/hooks.json
- hooks/README.md provides complete documentation
- All 9 HOOK requirements are addressed:
  - HOOK-01: pre-commit hook ✓
  - HOOK-02: post-checkout hook ✓
  - HOOK-03: pre-push hook ✓
  - HOOK-04: File watcher (deferred per context) ✓
  - HOOK-05: Hook installer ✓
  - HOOK-06: Hook configuration file ✓
  - HOOK-07: Selective hook enablement ✓
  - HOOK-08: Hook bypass mechanism ✓
  - HOOK-09: Dry-run mode ✓
- All 5 success criteria can be met
</success_criteria>

<output>
After completion, create `.planning/phases/09-hooks-system/09-04-SUMMARY.md`
</output>
