---
phase: 09-hooks-system
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - hooks/config/default.json
  - hooks/lib/hooks-config.sh
autonomous: true

must_haves:
  truths:
    - "Hook configuration file exists with sensible defaults"
    - "Configuration can be loaded from multiple sources with proper precedence"
    - "Each hook type can be independently enabled/disabled"
    - "Bypass mechanism is configurable via environment variable"
    - "Dry-run mode is supported"
  artifacts:
    - path: "hooks/config/default.json"
      provides: "Default hook configuration with all settings"
      contains: '["enabled_hooks", "timeout_seconds", "auto_fix", "file_patterns", "dry_run"]'
    - path: "hooks/lib/hooks-config.sh"
      provides: "Configuration loading library"
      exports: ["hooks_config_load", "hooks_config_get", "hooks_config_is_enabled"]
  key_links:
    - from: "hooks/lib/hooks-config.sh"
      to: "hooks/config/default.json"
      via: "jq parsing"
      pattern: 'jq.*default\.json'
---

<objective>
Create the hooks configuration system with JSON config files and a Bash library for loading settings with proper precedence (env > project config > user config > defaults).

Purpose: Provide centralized configuration for all git hooks with support for selective enablement, bypass mechanisms, and dry-run mode.
Output: Default config file and configuration library that other hook components will use.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@mcp-bridge/lib/config.sh
@mcp-bridge/config/default.json

Phase 8 established the configuration pattern:
- Precedence: environment > user config > defaults
- Library naming: mcp_* prefix for MCP, hooks_* prefix for hooks
- jq required for JSON parsing
- Config directory: ~/.config/kimi-mcp/ for MCP, ~/.config/kimi/ for hooks
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create default hooks configuration file</name>
  <files>hooks/config/default.json</files>
  <action>
Create hooks/config/default.json with the following structure:

{
  "version": "1.0",
  "enabled_hooks": ["pre-commit", "post-checkout", "pre-push"],
  "timeout_seconds": 60,
  "auto_fix": false,
  "dry_run": false,
  "file_patterns": ["*.py", "*.js", "*.ts", "*.jsx", "*.tsx", "*.sh", "*.bash", "*.rb", "*.go", "*.rs"],
  "bypass_env_var": "KIMI_HOOKS_SKIP",
  "hooks": {
    "pre-commit": {
      "enabled": true,
      "auto_fix": false,
      "check_types": ["lint", "format", "types"],
      "max_files": 50
    },
    "post-checkout": {
      "enabled": true,
      "max_files": 20,
      "show_summary": true,
      "analyze_branches": true
    },
    "pre-push": {
      "enabled": true,
      "run_tests": false,
      "test_command": "",
      "auto_fix_failures": false,
      "timeout_seconds": 120
    }
  }
}

Ensure valid JSON with proper formatting. Include comments in the file header explaining each section.
  </action>
  <verify>cat hooks/config/default.json | jq . > /dev/null && echo "Valid JSON"</verify>
  <done>Default config file exists with all required fields and validates as proper JSON</done>
</task>

<task type="auto">
  <name>Task 2: Create hooks configuration library</name>
  <files>hooks/lib/hooks-config.sh</files>
  <action>
Create hooks/lib/hooks-config.sh following the pattern from mcp-bridge/lib/config.sh:

1. Header with purpose, usage, and dependencies
2. Global variables: HOOKS_CONFIG_* for each setting
3. Main function: hooks_config_load() - loads config with precedence:
   - Environment variables (highest)
   - Project config (.kimi/hooks.json) 
   - User config (~/.config/kimi/hooks.json)
   - Default config (hooks/config/default.json)
4. Accessor functions:
   - hooks_config_get(key) - get any config value by key path
   - hooks_config_is_enabled(hook_type) - check if specific hook is enabled
   - hooks_config_timeout() - get timeout (with hook-specific override support)
   - hooks_config_auto_fix(hook_type) - get auto_fix setting for hook
   - hooks_config_file_patterns() - get file patterns array
   - hooks_config_is_dry_run() - check dry-run mode
5. Helper functions:
   - hooks_config_ensure_dir() - create ~/.config/kimi/ if needed
   - _hooks_config_validate() - internal validation

Key differences from MCP config:
- Support hook-specific overrides (e.g., pre-push.timeout_seconds overrides global)
- Support array values for file_patterns, enabled_hooks
- Boolean parsing for enabled, auto_fix, dry_run

Error handling:
- Log to stderr
- Return non-zero on failure
- Graceful fallback to defaults if jq missing
  </action>
  <verify>bash -n hooks/lib/hooks-config.sh && echo "Syntax OK"</verify>
  <done>Config library exists with all required functions and passes syntax check</done>
</task>

<task type="auto">
  <name>Task 3: Create configuration test suite</name>
  <files>hooks/tests/test-config.bats</files>
  <action>
Create hooks/tests/test-config.bats following the pattern from mcp-bridge/tests/:

Test cases should cover:
1. Loading default configuration
2. User config override (~/.config/kimi/hooks.json)
3. Project config override (.kimi/hooks.json)
4. Environment variable override (KIMI_HOOKS_*)
5. Precedence order verification
6. hooks_config_is_enabled() for each hook type
7. hooks_config_get() for nested values
8. Hook-specific settings override global
9. Missing jq graceful degradation
10. Invalid JSON handling

Use bats testing framework (same as Phase 8).
Include setup() and teardown() functions.
Mock external dependencies where appropriate.
  </action>
  <verify>[[ -f hooks/tests/test-config.bats ]] && head -20 hooks/tests/test-config.bats | grep -q "#!/usr/bin/env bats"</verify>
  <done>Test file exists with proper bats header and comprehensive test cases</done>
</task>

</tasks>

<verification>
1. Default config validates as JSON: `cat hooks/config/default.json | jq .`
2. Config library loads without errors: `source hooks/lib/hooks-config.sh && hooks_config_load`
3. All accessor functions work: `hooks_config_is_enabled pre-commit` returns true
4. Test suite runs (or at least has valid syntax): `bats hooks/tests/test-config.bats` or syntax check
</verification>

<success_criteria>
- hooks/config/default.json exists with valid JSON containing all required fields
- hooks/lib/hooks-config.sh provides configuration loading with proper precedence
- All 9 HOOK requirements are supported by configuration:
  - HOOK-06: Hook configuration file ✓
  - HOOK-07: Selective hook enablement ✓
  - HOOK-08: Hook bypass mechanism (via env var) ✓
  - HOOK-09: Dry-run mode ✓
</success_criteria>

<output>
After completion, create `.planning/phases/09-hooks-system/09-01-SUMMARY.md`
</output>
