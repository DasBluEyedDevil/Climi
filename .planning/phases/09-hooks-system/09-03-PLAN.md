---
phase: 09-hooks-system
plan: 03
type: execute
wave: 3
depends_on: [09-02]
files_modified:
  - bin/kimi-hooks
  - bin/kimi-hooks-setup
  - hooks/lib/install.sh
autonomous: true

must_haves:
  truths:
    - "Hooks can be installed globally (applies to all repos)"
    - "Hooks can be installed per-project (repo-specific)"
    - "Installer creates symlinks to hook scripts in the correct locations"
    - "Uninstaller removes installed hooks"
    - "Status command shows current installation state"
  artifacts:
    - path: "bin/kimi-hooks"
      provides: "CLI entry point for hooks management"
      exports: ["install", "uninstall", "status", "enable", "disable"]
    - path: "bin/kimi-hooks-setup"
      provides: "Setup helper for hook installation"
      exports: ["install", "uninstall", "status"]
    - path: "hooks/lib/install.sh"
      provides: "Installation library functions"
      exports: ["hooks_install_global", "hooks_install_local", "hooks_uninstall"]
  key_links:
    - from: "bin/kimi-hooks-setup"
      to: "hooks/hooks/"
      via: "symlink creation"
      pattern: 'ln -s.*hooks/'
    - from: "bin/kimi-hooks-setup"
      to: "~/.config/git/hooks/"
      via: "global install target"
    - from: "bin/kimi-hooks-setup"
      to: ".git/hooks/"
      via: "local install target"
---

<objective>
Create the hook installer that can install hooks globally (for all repos) or locally (per-project).

Purpose: Provide easy installation and management of git hooks with support for both global and per-project setups.
Output: CLI tools (kimi-hooks, kimi-hooks-setup) and installation library for managing hook installation.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@bin/kimi-mcp-setup
@install.sh

From 09-RESEARCH.md:
- Global hooks: ~/.config/git/hooks/ (Git 2.9+)
- Local hooks: .git/hooks/ (per-repo)
- Installation creates symlinks from our hook scripts to git hooks directory
- Uninstallation removes the symlinks
- Status shows which hooks are installed where

From bin/kimi-mcp-setup (pattern to follow):
- Support install/remove/status commands
- Check if already installed before installing
- Provide clear output about what was done
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create hooks installation library</name>
  <files>hooks/lib/install.sh</files>
  <action>
Create hooks/lib/install.sh with installation functions:

#!/bin/bash
# Hook installation library

HOOKS_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
HOOK_SCRIPTS_DIR="$HOOKS_DIR/hooks"

# Hook types we support
HOOK_TYPES=("pre-commit" "post-checkout" "pre-push")

# Get global hooks directory (~/.config/git/hooks/)
hooks_get_global_dir() {
    echo "${HOME}/.config/git/hooks"
}

# Get local hooks directory (.git/hooks/)
hooks_get_local_dir() {
    if [[ -d ".git" ]]; then
        echo "$(pwd)/.git/hooks"
    else
        git rev-parse --git-path hooks 2>/dev/null
    fi
}

# Check if global hooks directory exists
hooks_global_dir_exists() {
    [[ -d "$(hooks_get_global_dir)" ]]
}

# Create global hooks directory
hooks_create_global_dir() {
    local global_dir
    global_dir=$(hooks_get_global_dir)
    mkdir -p "$global_dir"
    echo "Created global hooks directory: $global_dir"
}

# Install hooks globally
hooks_install_global() {
    local global_dir
    global_dir=$(hooks_get_global_dir)
    
    if ! hooks_global_dir_exists; then
        hooks_create_global_dir
    fi
    
    local installed=()
    local skipped=()
    
    for hook in "${HOOK_TYPES[@]}"; do
        local source="$HOOK_SCRIPTS_DIR/$hook"
        local target="$global_dir/$hook"
        
        if [[ -L "$target" ]]; then
            skipped+=("$hook (already installed)")
        elif [[ -e "$target" ]]; then
            skipped+=("$hook (exists, not a symlink - manual install?)")
        else
            ln -s "$source" "$target"
            installed+=("$hook")
        fi
    done
    
    echo "Global installation complete:"
    [[ ${#installed[@]} -gt 0 ]] && echo "  Installed: ${installed[*]}"
    [[ ${#skipped[@]} -gt 0 ]] && echo "  Skipped: ${skipped[*]}"
    
    # Remind about core.hooksPath if needed
    local current_path
    current_path=$(git config --global core.hooksPath 2>/dev/null)
    if [[ -z "$current_path" ]]; then
        echo ""
        echo "Note: To enable global hooks, run:"
        echo "  git config --global core.hooksPath '$global_dir'"
    fi
}

# Install hooks locally
hooks_install_local() {
    local local_dir
    local_dir=$(hooks_get_local_dir)
    
    if [[ -z "$local_dir" ]] || [[ ! -d "$local_dir" ]]; then
        echo "Error: Not in a git repository or .git directory not found"
        return 1
    fi
    
    local installed=()
    local skipped=()
    local backed_up=()
    
    for hook in "${HOOK_TYPES[@]}"; do
        local source="$HOOK_SCRIPTS_DIR/$hook"
        local target="$local_dir/$hook"
        
        if [[ -L "$target" ]]; then
            skipped+=("$hook (already installed)")
        elif [[ -e "$target" ]]; then
            # Backup existing hook
            mv "$target" "$target.backup.$(date +%Y%m%d%H%M%S)"
            backed_up+=("$hook")
            ln -s "$source" "$target"
            installed+=("$hook")
        else
            ln -s "$source" "$target"
            installed+=("$hook")
        fi
    done
    
    echo "Local installation complete:"
    [[ ${#installed[@]} -gt 0 ]] && echo "  Installed: ${installed[*]}"
    [[ ${#backed_up[@]} -gt 0 ]] && echo "  Backed up: ${backed_up[*]}"
    [[ ${#skipped[@]} -gt 0 ]] && echo "  Skipped: ${skipped[*]}"
}

# Uninstall hooks
hooks_uninstall() {
    local scope="${1:-all}"  # global, local, or all
    
    local removed=()
    local not_found=()
    
    if [[ "$scope" == "global" ]] || [[ "$scope" == "all" ]]; then
        local global_dir
        global_dir=$(hooks_get_global_dir)
        
        for hook in "${HOOK_TYPES[@]}"; do
            local target="$global_dir/$hook"
            if [[ -L "$target" ]]; then
                rm "$target"
                removed+=("$hook (global)")
            else
                not_found+=("$hook (global)")
            fi
        done
    fi
    
    if [[ "$scope" == "local" ]] || [[ "$scope" == "all" ]]; then
        local local_dir
        local_dir=$(hooks_get_local_dir)
        
        if [[ -n "$local_dir" ]]; then
            for hook in "${HOOK_TYPES[@]}"; do
                local target="$local_dir/$hook"
                if [[ -L "$target" ]]; then
                    rm "$target"
                    removed+=("$hook (local)")
                else
                    not_found+=("$hook (local)")
                fi
            done
        fi
    fi
    
    echo "Uninstallation complete:"
    [[ ${#removed[@]} -gt 0 ]] && echo "  Removed: ${removed[*]}"
    [[ ${#not_found[@]} -gt 0 ]] && echo "  Not found: ${not_found[*]}"
}

# Show installation status
hooks_status() {
    echo "Kimi Git Hooks Status"
    echo "====================="
    echo ""
    
    # Global status
    local global_dir
    global_dir=$(hooks_get_global_dir)
    echo "Global hooks directory: $global_dir"
    
    if hooks_global_dir_exists; then
        local global_hooks_path
        global_hooks_path=$(git config --global core.hooksPath 2>/dev/null)
        if [[ "$global_hooks_path" == "$global_dir" ]]; then
            echo "  Status: ENABLED via core.hooksPath"
        else
            echo "  Status: directory exists but not enabled (run 'git config --global core.hooksPath $global_dir')"
        fi
        
        echo "  Installed hooks:"
        for hook in "${HOOK_TYPES[@]}"; do
            local target="$global_dir/$hook"
            if [[ -L "$target" ]]; then
                local link_target
                link_target=$(readlink "$target")
                echo "    ✓ $hook -> $link_target"
            else
                echo "    ✗ $hook (not installed)"
            fi
        done
    else
        echo "  Status: directory does not exist"
    fi
    
    echo ""
    
    # Local status
    local local_dir
    local_dir=$(hooks_get_local_dir)
    if [[ -n "$local_dir" ]]; then
        echo "Local hooks directory: $local_dir"
        echo "  Installed hooks:"
        for hook in "${HOOK_TYPES[@]}"; do
            local target="$local_dir/$hook"
            if [[ -L "$target" ]]; then
                local link_target
                link_target=$(readlink "$target")
                echo "    ✓ $hook -> $link_target"
            elif [[ -e "$target" ]]; then
                echo "    ! $hook (exists but not managed by kimi-hooks)"
            else
                echo "    ✗ $hook (not installed)"
            fi
        done
    else
        echo "Local hooks: not in a git repository"
    fi
    
    echo ""
    echo "Configuration:"
    if [[ -f "$HOME/.config/kimi/hooks.json" ]]; then
        echo "  User config: $HOME/.config/kimi/hooks.json"
    else
        echo "  User config: not found (using defaults)"
    fi
    
    if [[ -f ".kimi/hooks.json" ]]; then
        echo "  Project config: .kimi/hooks.json"
    else
        echo "  Project config: not found"
    fi
}
  </action>
  <verify>bash -n hooks/lib/install.sh && echo "Syntax OK"</verify>
  <done>Installation library exists with all functions and passes syntax check</done>
</task>

<task type="auto">
  <name>Task 2: Create kimi-hooks-setup CLI tool</name>
  <files>bin/kimi-hooks-setup</files>
  <action>
Create bin/kimi-hooks-setup following the pattern of bin/kimi-mcp-setup:

#!/bin/bash
# kimi-hooks-setup: Setup helper for Kimi git hooks

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"

# Source the installation library
source "$PROJECT_ROOT/hooks/lib/install.sh"

VERSION="1.0.0"

show_help() {
    cat << EOF
Kimi Git Hooks Setup Helper v${VERSION}

Usage: kimi-hooks-setup <command> [options]

Commands:
  install [--global|--local]   Install hooks (default: local)
  uninstall [--global|--local] Uninstall hooks (default: all)
  status                       Show installation status
  --help                       Show this help message
  --version                    Show version

Examples:
  kimi-hooks-setup install --global    # Install hooks globally
  kimi-hooks-setup install --local     # Install hooks in current repo
  kimi-hooks-setup uninstall           # Remove all hooks
  kimi-hooks-setup status              # Check what's installed

Global hooks apply to all repositories (requires Git 2.9+).
Local hooks apply only to the current repository.
EOF
}

cmd_install() {
    local scope="local"
    
    while [[ $# -gt 0 ]]; do
        case "$1" in
            --global)
                scope="global"
                shift
                ;;
            --local)
                scope="local"
                shift
                ;;
            *)
                echo "Unknown option: $1"
                show_help
                exit 1
                ;;
        esac
    done
    
    if [[ "$scope" == "global" ]]; then
        hooks_install_global
    else
        hooks_install_local
    fi
}

cmd_uninstall() {
    local scope="all"
    
    while [[ $# -gt 0 ]]; do
        case "$1" in
            --global)
                scope="global"
                shift
                ;;
            --local)
                scope="local"
                shift
                ;;
            *)
                echo "Unknown option: $1"
                show_help
                exit 1
                ;;
        esac
    done
    
    hooks_uninstall "$scope"
}

cmd_status() {
    hooks_status
}

main() {
    case "${1:-}" in
        install)
            shift
            cmd_install "$@"
            ;;
        uninstall)
            shift
            cmd_uninstall "$@"
            ;;
        status)
            shift
            cmd_status "$@"
            ;;
        --help|-h)
            show_help
            ;;
        --version|-v)
            echo "kimi-hooks-setup v${VERSION}"
            ;;
        *)
            echo "Unknown command: ${1:-}"
            show_help
            exit 1
            ;;
    esac
}

main "$@"

Make the script executable.
  </action>
  <verify>bash -n bin/kimi-hooks-setup && test -x bin/kimi-hooks-setup && echo "Executable and syntax OK"</verify>
  <done>kimi-hooks-setup exists, is executable, and passes syntax check</done>
</task>

<task type="auto">
  <name>Task 3: Create kimi-hooks CLI wrapper</name>
  <files>bin/kimi-hooks</files>
  <action>
Create bin/kimi-hooks as a higher-level CLI wrapper:

#!/bin/bash
# kimi-hooks: CLI for managing Kimi git hooks

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"

# Source the installation library
source "$PROJECT_ROOT/hooks/lib/install.sh"

VERSION="1.0.0"

show_help() {
    cat << EOF
Kimi Git Hooks CLI v${VERSION}

Usage: kimi-hooks <command> [options]

Commands:
  install [--global|--local]   Install hooks (default: local)
  uninstall [--global|--local] Uninstall hooks (default: all)
  status                       Show installation status
  enable <hook>                Enable a hook type
  disable <hook>               Disable a hook type
  config                       Open configuration in editor
  --help                       Show this help message
  --version                    Show version

Hook Types:
  pre-commit      Run before each commit
  post-checkout   Run after branch checkout
  pre-push        Run before each push

Examples:
  kimi-hooks install --global        # Install hooks globally
  kimi-hooks enable pre-commit       # Enable pre-commit hook
  kimi-hooks disable pre-push        # Disable pre-push hook
  kimi-hooks config                  # Edit configuration

Environment Variables:
  KIMI_HOOKS_SKIP=1    Skip all hooks
  EDITOR               Editor for config command
EOF
}

cmd_install() {
    # Delegate to kimi-hooks-setup
    exec "$PROJECT_ROOT/bin/kimi-hooks-setup" install "$@"
}

cmd_uninstall() {
    # Delegate to kimi-hooks-setup
    exec "$PROJECT_ROOT/bin/kimi-hooks-setup" uninstall "$@"
}

cmd_status() {
    # Delegate to kimi-hooks-setup
    exec "$PROJECT_ROOT/bin/kimi-hooks-setup" status "$@"
}

cmd_enable() {
    local hook="${1:-}"
    if [[ -z "$hook" ]]; then
        echo "Error: Hook type required"
        echo "Usage: kimi-hooks enable <hook-type>"
        echo "Valid types: pre-commit, post-checkout, pre-push"
        exit 1
    fi
    
    # Create or update user config
    local config_dir="$HOME/.config/kimi"
    local config_file="$config_dir/hooks.json"
    
    mkdir -p "$config_dir"
    
    if [[ -f "$config_file" ]]; then
        # Update existing config
        jq --arg hook "$hook" '
            if .hooks[$hook] then
                .hooks[$hook].enabled = true
            else
                .hooks[$hook] = {"enabled": true}
            end
        ' "$config_file" > "$config_file.tmp" && mv "$config_file.tmp" "$config_file"
    else
        # Create new config
        cat > "$config_file" << EOF
{
  "version": "1.0",
  "hooks": {
    "$hook": {
      "enabled": true
    }
  }
}
EOF
    fi
    
    echo "Enabled $hook hook in $config_file"
}

cmd_disable() {
    local hook="${1:-}"
    if [[ -z "$hook" ]]; then
        echo "Error: Hook type required"
        echo "Usage: kimi-hooks disable <hook-type>"
        echo "Valid types: pre-commit, post-checkout, pre-push"
        exit 1
    fi
    
    # Create or update user config
    local config_dir="$HOME/.config/kimi"
    local config_file="$config_dir/hooks.json"
    
    mkdir -p "$config_dir"
    
    if [[ -f "$config_file" ]]; then
        # Update existing config
        jq --arg hook "$hook" '
            if .hooks[$hook] then
                .hooks[$hook].enabled = false
            else
                .hooks[$hook] = {"enabled": false}
            end
        ' "$config_file" > "$config_file.tmp" && mv "$config_file.tmp" "$config_file"
    else
        # Create new config
        cat > "$config_file" << EOF
{
  "version": "1.0",
  "hooks": {
    "$hook": {
      "enabled": false
    }
  }
}
EOF
    fi
    
    echo "Disabled $hook hook in $config_file"
}

cmd_config() {
    local config_dir="$HOME/.config/kimi"
    local config_file="$config_dir/hooks.json"
    
    if [[ ! -f "$config_file" ]]; then
        mkdir -p "$config_dir"
        cp "$PROJECT_ROOT/hooks/config/default.json" "$config_file"
        echo "Created default config at $config_file"
    fi
    
    ${EDITOR:-vi} "$config_file"
}

main() {
    case "${1:-}" in
        install)
            shift
            cmd_install "$@"
            ;;
        uninstall)
            shift
            cmd_uninstall "$@"
            ;;
        status)
            shift
            cmd_status "$@"
            ;;
        enable)
            shift
            cmd_enable "$@"
            ;;
        disable)
            shift
            cmd_disable "$@"
            ;;
        config)
            shift
            cmd_config "$@"
            ;;
        --help|-h)
            show_help
            ;;
        --version|-v)
            echo "kimi-hooks v${VERSION}"
            ;;
        *)
            echo "Unknown command: ${1:-}"
            show_help
            exit 1
            ;;
    esac
}

main "$@"

Make the script executable.
  </action>
  <verify>bash -n bin/kimi-hooks && test -x bin/kimi-hooks && echo "Executable and syntax OK"</verify>
  <done>kimi-hooks exists, is executable, and passes syntax check</done>
</task>

</tasks>

<verification>
1. All CLI tools are executable: `ls -la bin/kimi-hooks*`
2. All scripts pass syntax check: `bash -n bin/kimi-hooks bin/kimi-hooks-setup hooks/lib/install.sh`
3. Installation library can be sourced: `source hooks/lib/install.sh && echo "OK"`
4. Help works: `./bin/kimi-hooks --help`
</verification>

<success_criteria>
- bin/kimi-hooks provides user-friendly CLI for hook management
- bin/kimi-hooks-setup provides setup helper (install/uninstall/status)
- hooks/lib/install.sh provides reusable installation functions
- Global installation targets ~/.config/git/hooks/
- Local installation targets .git/hooks/
- HOOK-05 requirement met (Hook installer global/local)
</success_criteria>

<output>
After completion, create `.planning/phases/09-hooks-system/09-03-SUMMARY.md`
</output>
