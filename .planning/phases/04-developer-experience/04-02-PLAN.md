---
phase: 04-developer-experience
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - skills/kimi.agent.wrapper.sh
autonomous: true
must_haves:
  truths:
    - User can run `--dry-run` and see the exact Kimi CLI command without executing
    - Dry-run shows properly quoted command using printf '%q'
    - Dry-run shows truncated prompt preview (200 chars max)
    - User can run `--verbose` and see wrapper execution steps
    - Verbose output shows key decision points (role resolution, template loading, etc.)
  artifacts:
    - path: skills/kimi.agent.wrapper.sh
      provides: DRY_RUN and VERBOSE flags with supporting functions
      min_lines: 30
  key_links:
    - from: argument parsing
      to: DRY_RUN variable
      via: --dry-run case
      pattern: "--dry-run\\)\\s*DRY_RUN=true"
    - from: argument parsing
      to: VERBOSE variable
      via: --verbose case
      pattern: "--verbose\\)\\s*VERBOSE=true"
    - from: log_verbose()
      to: key decision points
      via: function calls throughout script
      pattern: "log_verbose.*"
    - from: dry-run check
      to: command display
      via: printf '%q' output
      pattern: "printf '%q'"
---

<objective>
Implement verbose mode and dry-run mode for debugging wrapper behavior.

Purpose: Users need visibility into wrapper internals for debugging and need to preview commands before execution for safety and understanding.

Output: Updated wrapper script with:
- `--verbose` flag and `log_verbose()` function for debug output
- `--dry-run` flag that displays the constructed command without executing
- Prompt preview (truncated to 200 chars) in dry-run mode
- Instrumentation at key decision points throughout the script
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-developer-experience/04-RESEARCH.md
@skills/kimi.agent.wrapper.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add --verbose flag and log_verbose() function</name>
  <files>skills/kimi.agent.wrapper.sh</files>
  <action>
1. Add VERBOSE=false to the defaults section (around line 36, after TEMPLATE="")

2. Add log_verbose() function after the warn() function (around line 41):
   ```bash
   log_verbose() {
       [[ "$VERBOSE" == "true" ]] || return 0
       echo "[verbose] $*" >&2
   }
   ```

3. Add --verbose case to argument parsing (around line 319, before -h|--help):
   ```bash
   --verbose)
       VERBOSE=true; shift ;;
   ```

4. Instrument key decision points with log_verbose calls:
   - After finding kimi binary: `log_verbose "Resolved kimi binary: $KIMI_BIN"`
   - After resolving agent: `log_verbose "Agent file: ${AGENT_FILE:-none}"`
   - After resolving template: `log_verbose "Template: ${TEMPLATE:-none}"`
   - Before command construction: `log_verbose "Model: $MODEL, Role: ${ROLE:-none}"`
   - After building cmd array: `log_verbose "Passthrough args: ${PASSTHROUGH_ARGS[*]}"`
   - Before execution: `log_verbose "Prompt length: ${#ASSEMBLED_PROMPT} chars"`
   - In capture_git_diff: `log_verbose "Git diff captured: ${#diff_output} chars"`
   - In load_context_file: `log_verbose "Context file loaded: $context_file"`

Use patterns from RESEARCH.md lines 216-238 for reference.
  </action>
  <verify>Run `skills/kimi.agent.wrapper.sh --verbose -r reviewer "test"` and verify:
- [verbose] lines appear showing wrapper execution steps
- Output includes "Resolved kimi binary", "Agent file", "Model", "Prompt length"
- Kimi still executes normally (unless --dry-run is also used)

Run without --verbose and confirm no [verbose] lines appear.</verify>
  <done>--verbose flag works and log_verbose() outputs debug info at key decision points</done>
</task>

<task type="auto">
  <name>Task 2: Add --dry-run flag and command display</name>
  <files>skills/kimi.agent.wrapper.sh</files>
  <action>
1. Add DRY_RUN=false to the defaults section (after VERBOSE=false)

2. Add --dry-run case to argument parsing (after --verbose case):
   ```bash
   --dry-run)
       DRY_RUN=true; shift ;;
   ```

3. Before the final execution line (line 434), add dry-run check and display:
   ```bash
   # Dry-run mode: show command without executing
   if [[ "$DRY_RUN" == "true" ]]; then
       echo "[DRY-RUN] Constructed command:" >&2
       printf '  %q' "${cmd[0]}" >&2
       for ((i=1; i<${#cmd[@]}; i++)); do
           printf ' %q' "${cmd[$i]}" >&2
       done
       echo "" >&2
       
       # Show truncated prompt preview
       if [[ ${#ASSEMBLED_PROMPT} -gt 200 ]]; then
           echo "[DRY-RUN] Assembled prompt (${#ASSEMBLED_PROMPT} chars):" >&2
           echo "  ${ASSEMBLED_PROMPT:0:200}..." >&2
       else
           echo "[DRY-RUN] Assembled prompt:" >&2
           echo "  $ASSEMBLED_PROMPT" >&2
       fi
       
       exit 0
   fi
   ```

4. Add log_verbose call before dry-run check: `log_verbose "Dry-run mode: $DRY_RUN"`

Use patterns from RESEARCH.md lines 188-214 for reference.

Important: Exit code must be 0 (success), not an error code.
  </action>
  <verify>Run `skills/kimi.agent.wrapper.sh --dry-run -r reviewer "test prompt"` and verify:
- Shows "[DRY-RUN] Constructed command:" line
- Shows properly quoted command with printf '%q' formatting
- Shows "[DRY-RUN] Assembled prompt:" with the prompt content
- Exits with code 0 (check with `echo $?`)
- Kimi CLI is NOT actually invoked

Run with a long prompt (>200 chars) and verify truncation shows "..." at end.</verify>
  <done>--dry-run flag displays constructed command and prompt preview without executing Kimi</done>
</task>

<task type="auto">
  <name>Task 3: Test combined --verbose --dry-run behavior</name>
  <files>skills/kimi.agent.wrapper.sh</files>
  <action>
Test that --verbose and --dry-run work together correctly:

1. Run `skills/kimi.agent.wrapper.sh --verbose --dry-run -r reviewer -t verify --diff "test"`
2. Verify output shows:
   - [verbose] lines showing execution steps
   - [DRY-RUN] lines showing command and prompt
   - No actual Kimi execution

3. Verify exit code is 0

This confirms both flags can be used together for maximum debugging information.
  </action>
  <verify>Run combined test and verify:
- Both [verbose] and [DRY-RUN] output appears
- Command is shown but not executed
- Exit code is 0
- All wrapper features (role, template, diff) are reflected in the displayed command</verify>
  <done>--verbose and --dry-run work correctly together</done>
</task>

</tasks>

<verification>
- [ ] `kimi.agent.wrapper.sh --verbose "test"` shows [verbose] debug output
- [ ] `kimi.agent.wrapper.sh --dry-run "test"` shows command without executing
- [ ] Dry-run displays properly quoted command using printf '%q'
- [ ] Dry-run shows prompt preview (truncated if >200 chars)
- [ ] Dry-run exits with code 0
- [ ] Combined `--verbose --dry-run` works correctly
- [ ] Verbose output goes to stderr
- [ ] Dry-run output goes to stderr
</verification>

<success_criteria>
1. User can run `--dry-run` and see the exact Kimi CLI command that would be executed, without executing it (WRAP-11)
2. User can run `--verbose` and see detailed wrapper execution steps (WRAP-14)
3. Dry-run shows truncated prompt preview (200 chars) with total character count
4. Both flags can be combined for debugging complex invocations
5. All output follows wrapper design principle (wrapper to stderr, only Kimi to stdout)
</success_criteria>

<output>
After completion, create `.planning/phases/04-developer-experience/04-02-SUMMARY.md`
</output>
