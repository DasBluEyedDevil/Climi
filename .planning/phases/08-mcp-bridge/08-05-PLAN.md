---
phase: 08-mcp-bridge
plan: 05
type: execute
wave: 5
depends_on:
  - 08-04
files_modified:
  - bin/kimi-mcp
  - bin/kimi-mcp-setup
  - install.sh (modifications)
autonomous: true
user_setup:
  - service: MCP Server
    why: "Users need to add MCP server to their PATH or use via full path"
    env_vars: []
    dashboard_config: []

must_haves:
  truths:
    - "kimi-mcp CLI command exists and can start the MCP server"
    - "kimi-mcp --help shows usage information"
    - "kimi-mcp --version shows version"
    - "kimi-mcp start launches the MCP server"
    - "kimi-mcp-setup configures Kimi CLI to use our MCP server"
    - "Install script installs the MCP bridge components"
  artifacts:
    - path: "bin/kimi-mcp"
      provides: "CLI entry point for MCP server"
      exports: ["start", "--help", "--version"]
    - path: "bin/kimi-mcp-setup"
      provides: "Setup helper for Kimi CLI MCP client integration"
      exports: ["install", "remove", "status"]
  key_links:
    - from: "bin/kimi-mcp"
      to: "mcp-bridge/bin/kimi-mcp-server"
      via: "exec"
      pattern: "exec.*kimi-mcp-server"
    - from: "bin/kimi-mcp-setup"
      to: "~/.kimi/mcp.json"
      via: "json manipulation"
      pattern: "mcpServers.*kimi-bridge"
---

<objective>
Create the CLI entry point (kimi-mcp) and integrate MCP bridge into the install script.

Purpose: Users need a simple way to start the MCP server and install the components.
Output: CLI wrapper and install script updates.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/phases/08-mcp-bridge/08-CONTEXT.md

# Requirements from ROADMAP.md:
# - CONF-09: CLI command to start MCP server

# From existing project structure:
# - bin/ directory contains CLI commands
# - install.sh installs components
# - Skills are installed to ~/.config/opencode/get-shit-done/skills/
</context>

<tasks>

<task type="auto">
  <name>Create kimimcp CLI wrapper</name>
  <files>bin/kimi-mcp</files>
  <action>
Create bin/kimi-mcp as the CLI entry point for the MCP server.

Shebang: #!/usr/bin/env bash

The script should support:

Usage: kimi-mcp [command] [options]

Commands:
  start           Start the MCP server (default)
  --help, -h      Show help message
  --version, -v   Show version

Implementation:

```bash
#!/usr/bin/env bash
set -e

# Determine installation directory
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(dirname "$SCRIPT_DIR")"

# Version
VERSION="1.0.0"

# Help message
show_help() {
    cat << 'EOF'
Kimi MCP Server - Expose Kimi as MCP tools

Usage: kimi-mcp [command]

Commands:
  start           Start the MCP server (reads JSON-RPC from stdin)
  --help, -h      Show this help message
  --version, -v   Show version information

Environment Variables:
  KIMI_MCP_MODEL       Default model (k2 or k2.5)
  KIMI_MCP_TIMEOUT     Default timeout in seconds

Configuration:
  ~/.config/kimi-mcp/config.json

Examples:
  # Start server
  kimi-mcp start

  # Test with a simple request
  echo '{"jsonrpc":"2.0","id":1,"method":"initialize"}' | kimi-mcp

For more information: https://github.com/dasblitz/climi
EOF
}

# Show version
show_version() {
    echo "kimi-mcp version $VERSION"
    echo "Protocol version: 2025-11-25"
}

# Start server
start_server() {
    local server_path="${PROJECT_ROOT}/mcp-bridge/bin/kimi-mcp-server"
    
    if [[ ! -f "$server_path" ]]; then
        echo "Error: MCP server not found at $server_path" >&2
        echo "Please run install.sh to install MCP bridge components" >&2
        exit 1
    fi
    
    exec "$server_path"
}

# Main
case "${1:-start}" in
    start)
        start_server
        ;;
    --help|-h)
        show_help
        ;;
    --version|-v)
        show_version
        ;;
    *)
        echo "Unknown command: $1" >&2
        echo "Run 'kimi-mcp --help' for usage" >&2
        exit 1
        ;;
esac
```

Make executable: chmod +x bin/kimi-mcp
  </action>
  <verify>chmod +x bin/kimi-mcp && ./bin/kimi-mcp --version | grep -q "1.0.0" && echo "OK"</verify>
  <done>CLI wrapper exists, is executable, and responds to --version and --help</done>
</task>

<task type="auto">
  <name>Update install.sh for MCP bridge</name>
  <files>install.sh</files>
  <action>
Read install.sh and add MCP bridge installation.

Add a new section for MCP bridge installation:

1. After the existing skill installation, add:

```bash
# Install MCP Bridge
install_mcp_bridge() {
    log_info "Installing MCP Bridge..."
    
    # Create MCP bridge directories
    mkdir -p "$INSTALL_DIR/mcp-bridge/lib"
    mkdir -p "$INSTALL_DIR/mcp-bridge/config"
    mkdir -p "$INSTALL_DIR/mcp-bridge/tests"
    mkdir -p "$INSTALL_DIR/bin"
    
    # Copy MCP bridge files
    cp -r "$PROJECT_ROOT/mcp-bridge/lib" "$INSTALL_DIR/mcp-bridge/"
    cp -r "$PROJECT_ROOT/mcp-bridge/config" "$INSTALL_DIR/mcp-bridge/"
    cp "$PROJECT_ROOT/mcp-bridge/bin/kimi-mcp-server" "$INSTALL_DIR/mcp-bridge/bin/"
    chmod +x "$INSTALL_DIR/mcp-bridge/bin/kimi-mcp-server"
    
    # Copy CLI wrapper
    cp "$PROJECT_ROOT/bin/kimi-mcp" "$INSTALL_DIR/bin/"
    chmod +x "$INSTALL_DIR/bin/kimi-mcp"
    
    # Create user config directory
    mkdir -p "$HOME/.config/kimi-mcp"
    
    # Copy default config if user config doesn't exist
    if [[ ! -f "$HOME/.config/kimi-mcp/config.json" ]]; then
        cp "$INSTALL_DIR/mcp-bridge/config/default.json" "$HOME/.config/kimi-mcp/config.json"
        log_info "Created default config at ~/.config/kimi-mcp/config.json"
    fi
    
    log_success "MCP Bridge installed"
}
```

2. Call install_mcp_bridge in the main install flow after skill installation.

3. Add to the PATH setup section (if applicable):
   - Mention that bin/kimi-mcp is available

4. Update the summary output to mention MCP bridge.

Preserve all existing install.sh functionality.
  </action>
  <verify>grep -q "install_mcp_bridge" install.sh && grep -q "kimi-mcp" install.sh && echo "OK"</verify>
  <done>install.sh updated to install MCP bridge components and CLI wrapper</done>
</task>

<task type="auto">
  <name>Create kimimcp-setup helper</name>
  <files>bin/kimi-mcp-setup</files>
  <action>
Create bin/kimi-mcp-setup to help users configure Kimi CLI to use our MCP server.

Since Kimi CLI has built-in MCP client support, this helper adds/removes our server from Kimi's config.

```bash
#!/usr/bin/env bash
set -e

VERSION="1.0.0"
KIMI_MCP_CONFIG="${HOME}/.kimi/mcp.json"

show_help() {
    cat << 'EOF'
Kimi MCP Setup - Configure Kimi CLI to use Kimi MCP Bridge

Usage: kimi-mcp-setup [command]

Commands:
  install         Add Kimi MCP Bridge to Kimi CLI's MCP servers
  remove          Remove Kimi MCP Bridge from Kimi CLI's MCP servers
  status          Show configuration status
  --help, -h      Show this help message
  --version, -v   Show version information

Examples:
  # Register our MCP server with Kimi CLI
  kimi-mcp-setup install

  # Check if configured
  kimi-mcp-setup status

  # Remove configuration
  kimi-mcp-setup remove

For more information: https://github.com/dasblitz/climi
EOF
}

show_version() {
    echo "kimi-mcp-setup version $VERSION"
}

get_server_path() {
    # Try to find the server executable
    local script_dir="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
    local project_root="$(dirname "$script_dir")"
    
    if [[ -f "$project_root/mcp-bridge/bin/kimi-mcp-server" ]]; then
        echo "$project_root/mcp-bridge/bin/kimi-mcp-server"
    elif [[ -f "${HOME}/.config/opencode/get-shit-done/mcp-bridge/bin/kimi-mcp-server" ]]; then
        echo "${HOME}/.config/opencode/get-shit-done/mcp-bridge/bin/kimi-mcp-server"
    else
        echo ""
    fi
}

install_config() {
    local server_path="$(get_server_path)"
    
    if [[ -z "$server_path" ]]; then
        echo "Error: Could not find kimi-mcp-server" >&2
        echo "Please run install.sh first" >&2
        exit 1
    fi
    
    # Ensure config directory exists
    mkdir -p "$(dirname "$KIMI_MCP_CONFIG")"
    
    # Read existing config or create new
    local config="{}"
    if [[ -f "$KIMI_MCP_CONFIG" ]]; then
        config="$(cat "$KIMI_MCP_CONFIG")"
    fi
    
    # Add our server to mcpServers
    local new_config="$(echo "$config" | jq --arg path "$server_path" '
        .mcpServers = (.mcpServers // {}) |
        .mcpServers["kimi-bridge"] = {
            "command": $path,
            "args": [],
            "env": {}
        }
    ')"
    
    echo "$new_config" > "$KIMI_MCP_CONFIG"
    echo "✓ Added kimi-bridge to Kimi MCP configuration"
    echo "  Config file: $KIMI_MCP_CONFIG"
    echo ""
    echo "You can now use Kimi MCP Bridge through Kimi CLI:"
    echo "  kimi mcp list"
    echo "  kimi mcp test kimi-bridge"
}

remove_config() {
    if [[ ! -f "$KIMI_MCP_CONFIG" ]]; then
        echo "No Kimi MCP configuration found"
        exit 0
    fi
    
    local config="$(cat "$KIMI_MCP_CONFIG")"
    local new_config="$(echo "$config" | jq 'del(.mcpServers["kimi-bridge"])')"
    
    echo "$new_config" > "$KIMI_MCP_CONFIG"
    echo "✓ Removed kimi-bridge from Kimi MCP configuration"
}

show_status() {
    echo "Kimi MCP Bridge Setup Status"
    echo "============================"
    echo ""
    
    # Check server executable
    local server_path="$(get_server_path)"
    if [[ -n "$server_path" && -f "$server_path" ]]; then
        echo "✓ Server executable: $server_path"
    else
        echo "✗ Server executable not found"
        echo "  Run: ./install.sh"
    fi
    
    # Check Kimi CLI MCP config
    echo ""
    if [[ -f "$KIMI_MCP_CONFIG" ]]; then
        echo "✓ Kimi MCP config: $KIMI_MCP_CONFIG"
        
        if jq -e '.mcpServers["kimi-bridge"]' "$KIMI_MCP_CONFIG" >/dev/null 2>&1; then
            echo "✓ kimi-bridge is registered"
            echo ""
            echo "Test with:"
            echo "  kimi mcp test kimi-bridge"
        else
            echo "○ kimi-bridge is NOT registered"
            echo ""
            echo "Register with:"
            echo "  kimi-mcp-setup install"
        fi
    else
        echo "○ Kimi MCP config not found"
        echo ""
        echo "Initialize with:"
        echo "  kimi-mcp-setup install"
    fi
}

# Main
case "${1:-status}" in
    install)
        install_config
        ;;
    remove)
        remove_config
        ;;
    status)
        show_status
        ;;
    --help|-h)
        show_help
        ;;
    --version|-v)
        show_version
        ;;
    *)
        echo "Unknown command: $1" >&2
        echo "Run 'kimi-mcp-setup --help' for usage" >&2
        exit 1
        ;;
esac
```

Make executable: chmod +x bin/kimi-mcp-setup
  </action>
  <verify>chmod +x bin/kimi-mcp-setup && ./bin/kimi-mcp-setup --version | grep -q "1.0.0" && echo "OK"</verify>
  <done>kimi-mcp-setup CLI exists, is executable, and supports install/remove/status commands</done>
</task>

<task type="auto">
  <name>Update install.sh for MCP bridge and setup</name>
  <files>install.sh</files>
  <action>
Read install.sh and add MCP bridge installation.

Add a new section for MCP bridge installation:

1. After the existing skill installation, add:

```bash
# Install MCP Bridge
install_mcp_bridge() {
    log_info "Installing MCP Bridge..."
    
    # Create MCP bridge directories
    mkdir -p "$INSTALL_DIR/mcp-bridge/lib"
    mkdir -p "$INSTALL_DIR/mcp-bridge/config"
    mkdir -p "$INSTALL_DIR/mcp-bridge/tests"
    mkdir -p "$INSTALL_DIR/bin"
    
    # Copy MCP bridge files
    cp -r "$PROJECT_ROOT/mcp-bridge/lib" "$INSTALL_DIR/mcp-bridge/"
    cp -r "$PROJECT_ROOT/mcp-bridge/config" "$INSTALL_DIR/mcp-bridge/"
    cp "$PROJECT_ROOT/mcp-bridge/bin/kimi-mcp-server" "$INSTALL_DIR/mcp-bridge/bin/"
    chmod +x "$INSTALL_DIR/mcp-bridge/bin/kimi-mcp-server"
    
    # Copy CLI wrappers
    cp "$PROJECT_ROOT/bin/kimi-mcp" "$INSTALL_DIR/bin/"
    chmod +x "$INSTALL_DIR/bin/kimi-mcp"
    cp "$PROJECT_ROOT/bin/kimi-mcp-setup" "$INSTALL_DIR/bin/"
    chmod +x "$INSTALL_DIR/bin/kimi-mcp-setup"
    
    # Create user config directory
    mkdir -p "$HOME/.config/kimi-mcp"
    
    # Copy default config if user config doesn't exist
    if [[ ! -f "$HOME/.config/kimi-mcp/config.json" ]]; then
        cp "$INSTALL_DIR/mcp-bridge/config/default.json" "$HOME/.config/kimi-mcp/config.json"
        log_info "Created default config at ~/.config/kimi-mcp/config.json"
    fi
    
    log_success "MCP Bridge installed"
    log_info "Run 'kimi-mcp-setup install' to register with Kimi CLI"
}
```

2. Call install_mcp_bridge in the main install flow after skill installation.

3. Add to the PATH setup section (if applicable):
   - Mention that bin/kimi-mcp and bin/kimi-mcp-setup are available

4. Update the summary output to mention MCP bridge and setup helper.

Preserve all existing install.sh functionality.
  </action>
  <verify>grep -q "install_mcp_bridge" install.sh && grep -q "kimi-mcp-setup" install.sh && echo "OK"</verify>
  <done>install.sh updated to install MCP bridge components, CLI wrappers, and mentions setup helper</done>
</task>

<task type="auto">
  <name>Create quick start documentation</name>
  <files>mcp-bridge/README.md</files>
  <action>
Create mcp-bridge/README.md with quick start guide for the MCP bridge.

Content:

```markdown
# Kimi MCP Bridge

Expose Kimi K2.5 as MCP (Model Context Protocol) tools for external AI systems.

## Installation

The MCP bridge is installed automatically with:
```bash
./install.sh
```

## Quick Start

### Option 1: Use as Standalone MCP Server

Start the MCP server directly:
```bash
kimi-mcp start
```

Or directly:
```bash
./mcp-bridge/bin/kimi-mcp-server
```

Other AI systems (Claude Code, etc.) can connect to this server via stdio.

### Option 2: Use Through Kimi CLI (Recommended)

Kimi CLI has built-in MCP client support. Register our server:

```bash
# Register Kimi MCP Bridge with Kimi CLI
kimi-mcp-setup install

# Verify it's working
kimi-mcp-setup status

# Test the connection
kimi mcp test kimi-bridge
```

Now Kimi CLI can use the bridge tools:
```bash
kimi mcp list
```

### Test the Server

```bash
# Initialize
echo '{"jsonrpc":"2.0","id":1,"method":"initialize","params":{"protocolVersion":"2025-11-25"}}' | kimi-mcp

# List tools
echo '{"jsonrpc":"2.0","id":2,"method":"tools/list"}' | kimi-mcp

# Call analyze tool
echo '{
  "jsonrpc": "2.0",
  "id": 3,
  "method": "tools/call",
  "params": {
    "name": "kimi_analyze",
    "arguments": {
      "prompt": "Explain this code",
      "files": ["./example.js"]
    }
  }
}' | kimi-mcp
```

## Configuration

### Server Configuration

Edit `~/.config/kimi-mcp/config.json`:

```json
{
  "model": "k2",
  "timeout": 30,
  "max_file_size": 1048576
}
```

Or use environment variables:
- `KIMI_MCP_MODEL` - Default model (k2 or k2.5)
- `KIMI_MCP_TIMEOUT` - Timeout in seconds

### Kimi CLI Integration

The `kimi-mcp-setup` helper manages Kimi CLI's MCP configuration at `~/.kimi/mcp.json`:

```bash
kimi-mcp-setup install   # Add to Kimi CLI
kimi-mcp-setup remove    # Remove from Kimi CLI
kimi-mcp-setup status    # Check configuration
```

## Available Tools

- `kimi_analyze` - Analyze code with specified role
- `kimi_implement` - Implement features/fixes
- `kimi_refactor` - Refactor with safety checks
- `kimi_verify` - Verify against requirements

## Testing

```bash
cd mcp-bridge
./tests/run-tests.sh
```
```

Make it concise but complete.
  </action>
  <verify>test -f mcp-bridge/README.md && grep -q "kimi_analyze" mcp-bridge/README.md && grep -q "kimi-mcp-setup" mcp-bridge/README.md && echo "OK"</verify>
  <done>README.md exists with installation, configuration, Kimi CLI integration, and usage instructions</done>
</task>

</tasks>

<verification>
- bin/kimi-mcp exists and is executable
- bin/kimi-mcp-setup exists and is executable
- CLI supports start, --help, --version commands
- Setup helper supports install, remove, status commands
- install.sh installs MCP bridge components
- User config directory is created during install
- Default config is copied if not exists
- README.md provides quick start guide with Kimi CLI integration
</verification>

<success_criteria>
1. bin/kimi-mcp CLI wrapper exists and works
2. bin/kimi-mcp-setup helper exists and works
3. install.sh installs mcp-bridge/ directory structure
4. install.sh creates ~/.config/kimi-mcp/ with default config
5. CLI wrapper can start the MCP server
6. Setup helper can register/unregister with Kimi CLI
7. README.md documents usage, configuration, and Kimi CLI integration
8. All components are executable after install
</success_criteria>

<output>
After completion, create `.planning/phases/08-mcp-bridge/08-05-SUMMARY.md`
</output>
