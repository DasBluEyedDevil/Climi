---
phase: 11-integration-distribution
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - install.sh
autonomous: true

must_haves:
  truths:
    - install.sh installs all v2.0 components (MCP server, hooks, model selection)
    - Installer detects and installs jq if missing
    - Installer creates MCP config during setup
    - Installer offers to install git hooks
    - Backward compatibility maintained for v1.0 users
  artifacts:
    - path: install.sh
      provides: v2.0 complete installation
      min_lines: 400
  key_links:
    - from: install.sh
      to: mcp-bridge/bin/kimi-mcp-server
      via: installation path setup
    - from: install.sh
      to: hooks/
      via: optional hooks installation
---

<objective>
Update install.sh for v2.0 to install all new components: MCP server, git hooks system, and model selection tools.

Purpose: Ensure new users get complete v2.0 functionality and existing users can upgrade seamlessly.
Output: Enhanced install.sh with v2.0 component installation, jq dependency check, and backward compatibility.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md
@.planning/phases/08-mcp-bridge/08-05-SUMMARY.md
@.planning/phases/09-hooks-system/09-04-SUMMARY.md
@.planning/phases/10-enhanced-skill/10-04-SUMMARY.md

# Current install.sh structure
@install.sh

# MCP server location
@mcp-bridge/bin/kimi-mcp-server

# Hooks installer
@hooks/lib/install.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add v2.0 component detection and installation</name>
  <files>install.sh</files>
  <action>
Update install.sh to install v2.0 components. Add the following:

1. **Version bump**: Change SCRIPT_VERSION to "2.0.0"

2. **jq dependency check**: Add function `check_jq()` that:
   - Checks if jq is installed (`command -v jq`)
   - If missing, shows installation instructions per OS:
     - macOS: `brew install jq`
     - Ubuntu/Debian: `sudo apt-get install jq`
     - Windows (Git Bash): `choco install jq` or manual install
   - Exits with error if jq not found (required for MCP)

3. **MCP server installation**: Add function `install_mcp_server()` that:
   - Creates `~/.local/bin/` if not exists
   - Copies `mcp-bridge/bin/kimi-mcp-server` to `~/.local/bin/`
   - Copies `bin/kimi-mcp` to `~/.local/bin/`
   - Makes both executable
   - Creates default `~/.config/kimi-mcp/config.json` if not exists:
     ```json
     {
       "model": "k2",
       "timeout": 300,
       "roles": {
         "analyze": "reviewer",
         "implement": "implementer",
         "refactor": "refactorer",
         "verify": "reviewer"
       }
     }
     ```

4. **Hooks installation option**: Add to interactive mode:
   - Prompt: "Install git hooks for auto-delegation? [Y/n]"
   - If yes, call `install_hooks()` function that:
     - Checks for git repository
     - Creates `.kimi/hooks.json` config if not exists
     - Installs hooks to `.git/hooks/`

5. **Model selection tools**: Add function `install_model_tools()` that:
   - Copies `bin/kimi-model-selector` to `~/.local/bin/` if exists
   - Copies `bin/kimi-cost-estimator` to `~/.local/bin/` if exists
   - Creates `~/.config/kimi/model-rules.json` if not exists with default rules

6. **Update help text**: Add v2.0 features to usage():
   - Mention MCP server installation
   - Mention hooks installation option
   - Mention jq dependency

7. **Add --with-hooks flag**: New CLI option to auto-install hooks without prompt

Maintain backward compatibility:
- Keep all v1.0 installation behavior as default
- v2.0 features are additive (installed alongside v1.0)
- Existing users running install.sh get upgraded seamlessly
  </action>
  <verify>grep -q "SCRIPT_VERSION=\"2.0.0\"" install.sh && grep -q "check_jq" install.sh && grep -q "install_mcp_server" install.sh</verify>
  <done>install.sh updated with v2.0 component installation, jq check, MCP setup, and hooks option</done>
</task>

<task type="auto">
  <name>Task 2: Add PATH verification and post-install summary</name>
  <files>install.sh</files>
  <action>
Add post-installation verification and user guidance:

1. **PATH check function** `verify_path()`:
   - Check if `~/.local/bin` is in PATH
   - If not, warn user and suggest adding to shell profile
   - Show exact command to add: `echo 'export PATH="$HOME/.local/bin:$PATH"' >> ~/.bashrc`

2. **Post-install summary** function `show_summary()`:
   - Display installed components with checkmarks
   - Show version numbers
   - List installed commands:
     - `kimi-mcp start` - Start MCP server
     - `kimi-hooks install` - Install git hooks
     - `kimi-model-selector` - Select model for task
   - Show next steps:
     - Test MCP: `echo '{"jsonrpc":"2.0","id":1,"method":"initialize"}' | kimi-mcp start`
     - Configure hooks: Edit `.kimi/hooks.json`
     - Read docs: `cat .claude/commands/kimi/kimi-mcp.md`

3. **Dry-run mode** `--dry-run`:
   - Show what would be installed without making changes
   - Useful for testing and CI

4. **Update prerequisite checks**:
   - Add jq to prerequisite list
   - Check bash version (require 4.0+)
   - Check kimi CLI version (require 1.7.0+)

5. **Backup existing configs**:
   - Before overwriting any config files, backup with timestamp
   - Show backup location to user
  </action>
  <verify>grep -q "verify_path" install.sh && grep -q "show_summary" install.sh && grep -q "dry-run" install.sh</verify>
  <done>install.sh has PATH verification, post-install summary, dry-run mode, and backup logic</done>
</task>

</tasks>

<verification>
- [ ] install.sh --help shows v2.0 options
- [ ] install.sh --dry-run shows what would be installed
- [ ] install.sh completes without errors
- [ ] jq check warns appropriately if missing
- [ ] Post-install summary displays correctly
- [ ] Backup mechanism works for existing configs
</verification>

<success_criteria>
1. install.sh installs all v2.0 components (MCP, hooks, model tools)
2. jq dependency is checked and installation guidance provided
3. Backward compatibility maintained for existing users
4. Post-install summary guides users to next steps
5. Dry-run mode works for testing
</success_criteria>

<output>
After completion, create `.planning/phases/11-integration-distribution/11-01-SUMMARY.md`
</output>
