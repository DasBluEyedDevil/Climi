#!/bin/bash
#
# Post-checkout hook: Analyze files changed between branches
#
# This hook runs after branch switches and analyzes changed files
# to provide context about what changed.
#

PREV_REF="$1"
NEW_REF="$2"
BRANCH_SWITCH="$3"  # 1 if branch switch, 0 if file checkout

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
HOOKS_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"

source "$HOOKS_ROOT/lib/hooks-config.sh"
source "$HOOKS_ROOT/lib/hooks-common.sh"

# Initialize hook
if ! hooks_init "post-checkout"; then
    exit 0
fi

# Skip if not a branch switch (just file checkout)
if [[ "$BRANCH_SWITCH" != "1" ]]; then
    hooks_log_debug "Not a branch switch, skipping"
    exit 0
fi

# Get files changed between refs
CHANGED_FILES=$(git diff --name-only "$PREV_REF" "$NEW_REF" 2>/dev/null || true)
if [[ -z "$CHANGED_FILES" ]]; then
    hooks_log_info "No files changed between branches"
    exit 0
fi

# Filter to matching patterns
MATCHING_FILES=$(hooks_filter_files "$CHANGED_FILES")
if [[ -z "$MATCHING_FILES" ]]; then
    hooks_log_info "No matching files to analyze"
    exit 0
fi

# Check max_files limit
MAX_FILES=$(hooks_config_get "hooks.post-checkout.max_files")
if [[ -z "$MAX_FILES" || "$MAX_FILES" == "null" ]]; then
    MAX_FILES=50  # Default limit
fi

FILE_COUNT=$(echo "$MATCHING_FILES" | grep -c '^' || echo "0")
if [[ "$FILE_COUNT" -gt "$MAX_FILES" ]]; then
    hooks_log_info "Too many files changed ($FILE_COUNT > $MAX_FILES), skipping analysis"
    exit 0
fi

hooks_log_info "Kimi is analyzing branch changes..."

# Build file list for MCP
FILE_JSON=$(echo "$MATCHING_FILES" | jq -R -s -c 'split("\n") | map(select(length > 0))')

# Get branch names for context
PREV_BRANCH=$(git name-rev --name-only "$PREV_REF" 2>/dev/null || echo "$PREV_REF")
NEW_BRANCH=$(git name-rev --name-only "$NEW_REF" 2>/dev/null || echo "$NEW_REF")

# Run analysis
PROMPT="Summarize the changes in these files between branches. Highlight important changes, potential conflicts, and context the developer should know."
CONTEXT="Switched from $PREV_BRANCH to $NEW_BRANCH"
RESULT=$(hooks_run_analysis "$PROMPT" "$FILE_JSON" "$CONTEXT")

if [[ -n "$RESULT" ]]; then
    echo ""
    echo "=== Branch Change Summary ==="
    echo "From: $PREV_BRANCH"
    echo "To: $NEW_BRANCH"
    echo ""
    echo "$RESULT"
    echo "==========================="
    echo ""
fi

exit 0
